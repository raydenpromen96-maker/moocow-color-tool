<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MooCow Mini Ë™øËâ≤„ÉÑ„Éº„É´ / Color Mixing Tool / Ë∞ÉËâ≤Â∑•ÂÖ∑ v6.5 (‰∏ì‰∏ö‰øÆÂ§çÁâà)</title>
<style>
/* ======================== CSS Ê†∑Âºè ======================== */
body {font-family: 'Segoe UI', 'Yu Gothic', 'Hiragino Sans', Tahoma, Geneva, Verdana, sans-serif;margin: 0;padding: 10px;background-color: #f4f4f4;color: #333;transition: all 0.3s ease;font-size: 14px;}
.container {max-width: 1200px;margin: auto;background: #fff;padding: 20px;border-radius: 12px;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);}
.header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 20px;border-bottom: 3px solid #3498db;padding-bottom: 10px;flex-wrap: wrap;gap: 10px;}
h1 {color: #2c3e50;margin: 0;flex: 1;font-size: 1.5em;min-width: 200px;}
.language-switcher {display: flex;gap: 6px;align-items: center;flex-shrink: 0;}
.lang-btn {padding: 8px 12px;border: 2px solid #3498db;background: transparent;color: #3498db;border-radius: 6px;cursor: pointer;font-weight: bold;transition: all 0.3s;font-size: 0.85em;min-width: 45px;text-align: center;}
.lang-btn.active {background: #3498db;color: white;}
.lang-btn:hover {background: #2980b9;color: white;border-color: #2980b9;}
.input-section {display: grid;grid-template-columns: 1fr 1fr 1fr;gap: 15px;margin-bottom: 20px;}
.input-group, .display-area {margin-bottom: 20px;padding: 15px;border: 1px solid #ddd;border-radius: 8px;background: #fafafa;}
label {display: block;margin-bottom: 8px;font-weight: bold;color: #34495e;font-size: 0.9em;}
.input-container {position: relative;display: flex;gap: 10px;}
#ralInput {flex: 1;padding: 12px;font-size: 1em;border: 2px solid #ccc;border-radius: 6px;transition: border-color 0.3s;min-height: 20px;}
#ralInput:focus {border-color: #3498db;outline: none;}
#ralSelect, #volumeSelect {flex: 1;padding: 12px;font-size: 1em;border: 2px solid #ccc;border-radius: 6px;background: white;cursor: pointer;min-height: 44px;}
#ralSelect:focus, #volumeSelect:focus {border-color: #3498db;outline: none;}
#colorPreview {height: 80px;border: 1px solid #ccc;border-radius: 6px;margin-top: 10px;transition: background-color 0.5s;display: flex;align-items: center;justify-content: center;font-size: 1em;color: #fff;text-shadow: 0 0 5px #000;font-weight: bold;}
.color-palette {margin-bottom: 20px;padding: 15px;border: 1px solid #ddd;border-radius: 8px;background: #fafafa;}
.color-palette h3 {margin-top: 0;margin-bottom: 15px;color: #2c3e50;font-size: 1.1em;}
.color-grid {display: grid;grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));gap: 6px;max-height: 300px;overflow-y: auto;padding: 10px;border: 1px solid #eee;border-radius: 6px;background: white;}
.color-swatch {width: 100%;height: 50px;border: 2px solid #ddd;border-radius: 6px;cursor: pointer;transition: all 0.3s;position: relative;display: flex;align-items: center;justify-content: center;font-size: 9px;font-weight: bold;text-shadow: 0 0 3px rgba(0,0,0,0.8);color: white;min-height: 50px;}
.color-swatch:hover {transform: scale(1.05);border-color: #3498db;box-shadow: 0 2px 8px rgba(0,0,0,0.3);z-index: 10;}
.color-swatch.selected {border-color: #e74c3c;border-width: 3px;transform: scale(1.02);}
.color-swatch .tooltip {position: absolute;bottom: -35px;left: 50%;transform: translateX(-50%);background: rgba(0,0,0,0.9);color: white;padding: 4px 8px;border-radius: 4px;font-size: 10px;white-space: nowrap;opacity: 0;pointer-events: none;transition: opacity 0.3s;z-index: 20;max-width: 120px;text-align: center;}
.color-swatch:hover .tooltip {opacity: 1;}
.details-grid {display: grid;grid-template-columns: 1fr 1fr;gap: 15px;margin-top: 15px;}
.detail-item {padding: 10px;background: #ecf0f1;border-radius: 4px;}
.detail-item strong {display: block;color: #2c3e50;}
#recipeList {list-style: none;padding: 0;}
#recipeList li {padding: 8px 0;border-bottom: 1px dashed #ddd;display: flex;justify-content: space-between;align-items: center;}
#recipeList li:last-child {border-bottom: none;}
.paint-weight {font-weight: bold;color: #27ae60;}
.paint-weight-grams {font-weight: bold;color: #e67e22;font-size: 1.1em;}
.error-message {color: #e74c3c;font-weight: bold;text-align: center;margin-top: 20px;}
.volume-info {background: #e8f5e8;border: 2px solid #27ae60;border-radius: 8px;padding: 12px;margin-top: 10px;text-align: center;}
.volume-info h4 {margin: 0 0 8px 0;color: #27ae60;font-size: 1em;}
.volume-display {font-size: 1.1em;font-weight: bold;color: #2c3e50;}
.color-difference {margin-top: 20px;padding: 15px;border: 1px solid #ddd;border-radius: 8px;background: #f8f9fa;}
.color-difference h3 {margin-top: 0;margin-bottom: 15px;color: #2c3e50;font-size: 1.1em;}
.comparison-section {display: grid;grid-template-columns: 1fr 1fr;gap: 15px;margin-bottom: 15px;}
.color-input-group {padding: 10px;border: 1px solid #ddd;border-radius: 6px;background: white;}
.color-input-group label {font-size: 0.9em;margin-bottom: 5px;}
.color-input-group input {width: 100%;padding: 8px;border: 1px solid #ccc;border-radius: 4px;font-size: 0.9em;box-sizing: border-box;}
.color-input-group input[type="number"] {-moz-appearance: textfield;}
.color-input-group input[type="number"]::-webkit-outer-spin-button,
.color-input-group input[type="number"]::-webkit-inner-spin-button {-webkit-appearance: none;margin: 0;}
.color-preview-small {width: 100%;height: 40px;border: 1px solid #ccc;border-radius: 4px;margin-top: 5px;display: flex;align-items: center;justify-content: center;font-size: 0.8em;font-weight: bold;color: white;text-shadow: 0 0 3px #000;}
.delta-e-result {text-align: center;padding: 15px;border-radius: 8px;font-weight: bold;font-size: 1.2em;}
.delta-e-excellent {background: #d4edda;color: #155724;border: 1px solid #c3e6cb;}
.delta-e-good {background: #fff3cd;color: #856404;border: 1px solid #ffeaa7;}
.delta-e-poor {background: #f8d7da;color: #721c24;border: 1px solid #f5c6cb;}
.delta-e-info {margin-top: 10px;font-size: 0.85em;color: #6c757d;text-align: center;}
.hidden {display: none !important;}
.debug-info {background: #f8f9fa;border: 1px solid #dee2e6;border-radius: 4px;padding: 10px;margin-top: 10px;font-family: monospace;font-size: 11px;max-height: 200px;overflow-y: auto;}
.btn {padding: 8px 16px;border: none;border-radius: 6px;cursor: pointer;font-weight: bold;transition: all 0.3s;font-size: 0.9em;}
.btn-primary {background: #3498db;color: white;}
.btn-primary:hover {background: #2980b9;}
.btn-secondary {background: #95a5a6;color: white;}
.btn-secondary:hover {background: #7f8c8d;}
@media (max-width: 768px) {body {padding: 5px;font-size: 13px;}.container {padding: 15px;border-radius: 8px;}.header {flex-direction: column;gap: 10px;text-align: center;margin-bottom: 15px;}h1 {font-size: 1.3em;min-width: auto;text-align: center;}.language-switcher {gap: 4px;justify-content: center;}.lang-btn {padding: 6px 10px;font-size: 0.8em;min-width: 40px;}.input-section {grid-template-columns: 1fr;gap: 10px;margin-bottom: 15px;}.input-group {padding: 12px;margin-bottom: 15px;}label {font-size: 0.85em;margin-bottom: 6px;}#ralInput, #ralSelect, #volumeSelect {padding: 10px;font-size: 0.9em;min-height: 40px;}#colorPreview {height: 60px;font-size: 0.9em;margin-top: 8px;}.volume-info {padding: 10px;margin-top: 8px;}.volume-info h4 {font-size: 0.9em;margin-bottom: 6px;}.volume-display {font-size: 1em;}.color-palette {padding: 12px;margin-bottom: 15px;}.color-palette h3 {font-size: 1em;margin-bottom: 10px;}.color-grid {grid-template-columns: repeat(6, 1fr);gap: 4px;max-height: 250px;padding: 8px;}.color-swatch {height: 40px;font-size: 8px;min-height: 40px;}.color-swatch .tooltip {font-size: 9px;padding: 3px 6px;bottom: -30px;}.details-grid {grid-template-columns: 1fr;gap: 10px;}.detail-item {padding: 8px;}.comparison-section {grid-template-columns: 1fr;gap: 10px;}.color-input-group {padding: 8px;}.color-preview-small {height: 35px;font-size: 0.75em;}.delta-e-result {padding: 12px;font-size: 1.1em;}.delta-e-info {font-size: 0.8em;}#recipeList li {flex-direction: column;align-items: flex-start;gap: 5px;padding: 10px 0;}.paint-weight-grams {font-size: 1em;}}
@media (max-width: 480px) {body {padding: 3px;font-size: 12px;}.container {padding: 10px;}h1 {font-size: 1.2em;}.lang-btn {padding: 5px 8px;font-size: 0.75em;min-width: 35px;}.color-grid {grid-template-columns: repeat(5, 1fr);gap: 3px;}.color-swatch {height: 35px;font-size: 7px;min-height: 35px;}#ralInput, #ralSelect, #volumeSelect {padding: 8px;font-size: 0.85em;}#colorPreview {height: 50px;font-size: 0.8em;}}
.color-grid::-webkit-scrollbar {width: 6px;}
.color-grid::-webkit-scrollbar-track {background: #f1f1f1;border-radius: 3px;}
.color-grid::-webkit-scrollbar-thumb {background: #888;border-radius: 3px;}
.color-grid::-webkit-scrollbar-thumb:hover {background: #555;}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1><span class="zh">üé® MooCow Mini Ë∞ÉËâ≤Â∑•ÂÖ∑ v6.5 (‰∏ì‰∏ö‰øÆÂ§çÁâà)</span><span class="en hidden">üé® MooCow Mini Color Mixing Tool v6.5 (Professional)</span><span class="ja hidden">üé® MooCow Mini Ë™øËâ≤„ÉÑ„Éº„É´ v6.5 („Éó„É≠Áâà)</span></h1>
<div class="language-switcher">
<button class="lang-btn active" onclick="switchLanguage('zh')">‰∏≠Êñá</button>
<button class="lang-btn" onclick="switchLanguage('en')">EN</button>
<button class="lang-btn" onclick="switchLanguage('ja')">Êó•Êú¨Ë™û</button>
</div>
</div>

<div class="input-section">
<div class="input-group">
<label for="ralInput"><span class="zh">ËæìÂÖ• RAL Ëâ≤Âè∑ (‰æãÂ¶Ç: 3020)</span><span class="en hidden">Enter RAL Color Code (e.g.: 3020)</span><span class="ja hidden">RALËâ≤Áï™Âè∑„ÇíÂÖ•Âäõ (‰æã: 3020)</span></label>
<div class="input-container">
<input type="text" id="ralInput" placeholder="">
</div>
<div id="colorPreview"><span class="zh">ËæìÂÖ•Ëâ≤Âè∑ÊàñÈÄâÊã©Ëâ≤ÂùóËøõË°åÊü•ËØ¢</span><span class="en hidden">Enter color code or select color swatch</span><span class="ja hidden">Ëâ≤Áï™Âè∑„ÇíÂÖ•Âäõ„Åô„Çã„ÅãËâ≤Ë¶ãÊú¨„ÇíÈÅ∏Êäû</span></div>
</div>

<div class="input-group">
<label for="ralSelect"><span class="zh">Êàñ‰ªé‰∏ãÊãâËèúÂçïÈÄâÊã© RAL Ëâ≤Âè∑</span><span class="en hidden">Or select RAL color code from dropdown</span><span class="ja hidden">„Åæ„Åü„ÅØ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Åã„ÇâRALËâ≤Áï™Âè∑„ÇíÈÅ∏Êäû</span></label>
<select id="ralSelect">
<option value=""><span class="zh">ËØ∑ÈÄâÊã© RAL Ëâ≤Âè∑...</span><span class="en hidden">Please select RAL color code...</span><span class="ja hidden">RALËâ≤Áï™Âè∑„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ...</span></option>
</select>
</div>

<div class="input-group">
<label for="volumeSelect"><span class="zh">ÈÄâÊã©ÈÄèÊòéÂü∫Á°ÄÊºÜÂÆπÈáè</span><span class="en hidden">Select Clear Base Volume</span><span class="ja hidden">ÈÄèÊòé„Éô„Éº„ÇπÂ°óÊñô„ÅÆÂÆπÈáè„ÇíÈÅ∏Êäû</span></label>
<select id="volumeSelect">
<option value="500">500ml</option>
<option value="1000" selected>1L (1000ml)</option>
<option value="5000">5L (5000ml)</option>
<option value="20000">20L (20000ml)</option>
</select>
<div class="volume-info">
<h4><span class="zh">ÈÄâÂÆöÂÆπÈáè</span><span class="en hidden">Selected Volume</span><span class="ja hidden">ÈÅ∏ÊäûÂÆπÈáè</span></h4>
<div class="volume-display" id="volumeDisplay">1L (1000ml)</div>
</div>
</div>
</div>

<div class="color-palette">
<h3><span class="zh">üé® RAL Ëâ≤Âç°ÈÄâÊã© (ÁÇπÂáªËâ≤ÂùóÂø´ÈÄüÈÄâÊã©)</span><span class="en hidden">üé® RAL Color Palette (Click to select)</span><span class="ja hidden">üé® RAL „Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà („ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû)</span></h3>
<div class="color-grid" id="colorGrid">
<!-- È¢úËâ≤ÂùóÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
</div>
</div>

<div class="display-area" id="colorDisplay" style="display: none;">
<div class="details-grid">
<div class="detail-item">
<strong><span class="zh">È¢úËâ≤‰ø°ÊÅØ</span><span class="en hidden">Color Information</span><span class="ja hidden">Ëâ≤ÊÉÖÂ†±</span></strong>
<div id="colorInfo"></div>
</div>
<div class="detail-item">
<strong><span class="zh">È¢úÊñôÈÖçÊñπ</span><span class="en hidden">Pigment Recipe</span><span class="ja hidden">È°îÊñôÈÖçÂêà</span></strong>
<ul id="recipeList"></ul>
</div>
</div>
</div>

<div class="error-message" id="errorMsg" style="display: none;">
<span class="zh">Êú™ÊâæÂà∞ËØ• RAL Ëâ≤Âè∑ÔºåËØ∑Ê£ÄÊü•ËæìÂÖ•ÊòØÂê¶Ê≠£Á°Æ</span>
<span class="en hidden">RAL color code not found, please check your input</span>
<span class="ja hidden">RALËâ≤Áï™Âè∑„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÂÖ•Âäõ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
</div>

<div class="color-difference">
<h3><span class="zh">üî¨ Ëâ≤Â∑ÆËÆ°ÁÆó (Delta E)</span><span class="en hidden">üî¨ Color Difference (Delta E)</span><span class="ja hidden">üî¨ Ëâ≤Â∑ÆË®àÁÆó (Delta E)</span></h3>
<div class="comparison-section">
<div class="color-input-group">
<label><span class="zh">ÁõÆÊ†áÈ¢úËâ≤ (LABÂÄº)</span><span class="en hidden">Target Color (LAB Values)</span><span class="ja hidden">ÁõÆÊ®ôËâ≤ (LABÂÄ§)</span></label>
<input type="number" id="targetL" placeholder="L (0-100)" min="0" max="100" step="0.1">
<input type="number" id="targetA" placeholder="a (-128 to 127)" min="-128" max="127" step="0.1">
<input type="number" id="targetB" placeholder="b (-128 to 127)" min="-128" max="127" step="0.1">
<div class="color-preview-small" id="targetColorPreview"><span class="zh">ÁõÆÊ†áÈ¢úËâ≤</span><span class="en hidden">Target Color</span><span class="ja hidden">ÁõÆÊ®ôËâ≤</span></div>
</div>
<div class="color-input-group">
<label><span class="zh">ÂÆûÈôÖÈ¢úËâ≤ (LABÂÄº)</span><span class="en hidden">Actual Color (LAB Values)</span><span class="ja hidden">ÂÆüÈöõ„ÅÆËâ≤ (LABÂÄ§)</span></label>
<input type="number" id="actualL" placeholder="L (0-100)" min="0" max="100" step="0.1">
<input type="number" id="actualA" placeholder="a (-128 to 127)" min="-128" max="127" step="0.1">
<input type="number" id="actualB" placeholder="b (-128 to 127)" min="-128" max="127" step="0.1">
<div class="color-preview-small" id="actualColorPreview"><span class="zh">ÂÆûÈôÖÈ¢úËâ≤</span><span class="en hidden">Actual Color</span><span class="ja hidden">ÂÆüÈöõ„ÅÆËâ≤</span></div>
</div>
</div>
<div style="text-align: center; margin-bottom: 15px;">
<button class="btn btn-primary" onclick="calculateDeltaE()"><span class="zh">ËÆ°ÁÆóËâ≤Â∑Æ</span><span class="en hidden">Calculate Delta E</span><span class="ja hidden">Ëâ≤Â∑Æ„ÇíË®àÁÆó</span></button>
<button class="btn btn-secondary" onclick="useCurrentColor()"><span class="zh">‰ΩøÁî®ÂΩìÂâçÈ¢úËâ≤</span><span class="en hidden">Use Current Color</span><span class="ja hidden">ÁèæÂú®„ÅÆËâ≤„Çí‰ΩøÁî®</span></button>
</div>
<div id="deltaEResult"></div>
</div>

<div class="debug-info" id="debugInfo" style="display: none;">
<strong><span class="zh">Ë∞ÉËØï‰ø°ÊÅØ</span><span class="en hidden">Debug Information</span><span class="ja hidden">„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</span></strong>
<div id="debugContent"></div>
</div>

</div>

<script>
// ======================== ÂÖ®Â±ÄÂèòÈáè ========================
let currentLanguage = 'zh';
let currentColorData = null;

// DOMÂÖÉÁ¥†ÂºïÁî®
let ralInput, ralSelect, volumeSelect, colorPreview, colorDisplay, errorMsg, recipeList, colorGrid;

// ======================== ‰øÆÂ§çÂêéÁöÑRALÈ¢úËâ≤Êï∞ÊçÆ ========================
const ralPaintMap = {
    '1000': { name: { zh: 'Á±≥ÁªøËâ≤', en: 'Green beige', ja: '„Ç∞„É™„Éº„É≥„Éô„Éº„Ç∏„É•' }, rgb: '#BEBD7F', lab: 'L:75.3, a:-8.2, b:25.4' },
    '1001': { name: { zh: 'Á±≥Ëâ≤', en: 'Beige', ja: '„Éô„Éº„Ç∏„É•' }, rgb: '#C2B078', lab: 'L:72.1, a:-2.1, b:22.8' },
    '1002': { name: { zh: 'Ê≤ôÈªÑËâ≤', en: 'Sand yellow', ja: '„Çµ„É≥„Éâ„Ç§„Ç®„É≠„Éº' }, rgb: '#C6A664', lab: 'L:68.9, a:2.3, b:28.7' },
    '1003': { name: { zh: '‰ø°Âè∑ÈªÑ', en: 'Signal yellow', ja: '„Ç∑„Ç∞„Éä„É´„Ç§„Ç®„É≠„Éº' }, rgb: '#E5BE01', lab: 'L:76.2, a:8.1, b:78.9' },
    '1004': { name: { zh: 'ÈáëÈªÑ', en: 'Golden yellow', ja: '„Ç¥„Éº„É´„Éá„É≥„Ç§„Ç®„É≠„Éº' }, rgb: '#CDA434', lab: 'L:67.8, a:12.4, b:65.2' },
    '1005': { name: { zh: 'ËúÇËúúÈªÑ', en: 'Honey yellow', ja: '„Éè„Éã„Éº„Ç§„Ç®„É≠„Éº' }, rgb: '#A98307', lab: 'L:54.2, a:15.6, b:58.3' },
    '1006': { name: { zh: 'ÁéâÁ±≥ÈªÑ', en: 'Maize yellow', ja: '„É°„Ç§„Ç∫„Ç§„Ç®„É≠„Éº' }, rgb: '#E4A010', lab: 'L:65.7, a:18.9, b:72.1' },
    '1007': { name: { zh: 'Ê∞¥‰ªôÈªÑ', en: 'Daffodil yellow', ja: '„ÉÄ„Éï„Ç©„Éá„Ç£„É´„Ç§„Ç®„É≠„Éº' }, rgb: '#DC9D00', lab: 'L:64.3, a:21.2, b:75.8' },
    '1011': { name: { zh: 'Ê£ïÁ±≥Ëâ≤', en: 'Brown beige', ja: '„Éñ„É©„Ç¶„É≥„Éô„Éº„Ç∏„É•' }, rgb: '#8A6642', lab: 'L:43.2, a:8.7, b:18.9' },
    '1012': { name: { zh: 'Êü†Ê™¨ÈªÑ', en: 'Lemon yellow', ja: '„É¨„É¢„É≥„Ç§„Ç®„É≠„Éº' }, rgb: '#C7B446', lab: 'L:72.5, a:-2.1, b:58.7' },
    '1013': { name: { zh: 'ÁèçÁè†ÁôΩ', en: 'Oyster white', ja: '„Ç™„Ç§„Çπ„Çø„Éº„Éõ„ÉØ„Ç§„Éà' }, rgb: '#EAE6CA', lab: 'L:91.2, a:-2.8, b:12.4' },
    '1014': { name: { zh: 'Ë±°ÁâôÈªÑ', en: 'Ivory', ja: '„Ç¢„Ç§„Éú„É™„Éº' }, rgb: '#E1CC4F', lab: 'L:81.7, a:-8.9, b:65.2' },
    '1015': { name: { zh: 'ÊµÖË±°Áâô', en: 'Light ivory', ja: '„É©„Ç§„Éà„Ç¢„Ç§„Éú„É™„Éº' }, rgb: '#E6D690', lab: 'L:85.3, a:-6.7, b:32.1' },
    '1016': { name: { zh: 'Á°´ÈªÑÈªÑ', en: 'Sulphur yellow', ja: '„Çµ„É´„Éï„Ç°„Éº„Ç§„Ç®„É≠„Éº' }, rgb: '#EDFF21', lab: 'L:94.2, a:-18.7, b:89.3' },
    '1017': { name: { zh: 'ËóèÁ∫¢Ëä±ÈªÑ', en: 'Saffron yellow', ja: '„Çµ„Éï„É©„É≥„Ç§„Ç®„É≠„Éº' }, rgb: '#F5D033', lab: 'L:83.6, a:2.1, b:78.9' },
    '1018': { name: { zh: 'ÈîåÈªÑ', en: 'Zinc yellow', ja: '„Ç∏„É≥„ÇØ„Ç§„Ç®„É≠„Éº' }, rgb: '#F8F32B', lab: 'L:91.8, a:-12.3, b:85.7' },
    '1019': { name: { zh: 'ÁÅ∞Á±≥Ëâ≤', en: 'Grey beige', ja: '„Ç∞„É¨„Éº„Éô„Éº„Ç∏„É•' }, rgb: '#9E9764', lab: 'L:61.2, a:-6.8, b:18.9' },
    '1020': { name: { zh: 'Ê©ÑÊ¶ÑÈªÑ', en: 'Olive yellow', ja: '„Ç™„É™„Éº„Éñ„Ç§„Ç®„É≠„Éº' }, rgb: '#999950', lab: 'L:62.1, a:-8.9, b:32.4' },
    '1021': { name: { zh: 'ËèúÁ±ΩÈªÑ', en: 'Rape yellow', ja: '„É¨„Ç§„Éó„Ç§„Ç®„É≠„Éº' }, rgb: '#F3DA0B', lab: 'L:86.7, a:1.2, b:82.3' },
    '3020': { name: { zh: '‰∫§ÈÄöÁ∫¢', en: 'Traffic red', ja: '„Éà„É©„Éï„Ç£„ÉÉ„ÇØ„É¨„ÉÉ„Éâ' }, rgb: '#B81D13', lab: 'L:40.5, a:59.3, b:48.0' },
    '9005': { name: { zh: 'Âñ∑Â∞ÑÈªë', en: 'Jet black', ja: '„Ç∏„Çß„ÉÉ„Éà„Éñ„É©„ÉÉ„ÇØ' }, rgb: '#0A0A0A', lab: 'L:4.2, a:0.1, b:-0.2' },
    '9010': { name: { zh: 'Á∫ØÁôΩ', en: 'Pure white', ja: '„Éî„É•„Ç¢„Éõ„ÉØ„Ç§„Éà' }, rgb: '#F4F4F4', lab: 'L:96.8, a:-0.2, b:1.8' }
};

// ======================== ‰øÆÂ§çÂêéÁöÑÈ¢úÊñôÈÖçÊñπÁ≥ªÁªü ========================
const PIGMENT_COVERAGE = {
    'titanium_white': 9.5,    // ÈíõÁôΩÁ≤â - ÊûÅÈ´òÈÅÆÁõñÂäõ
    'carbon_black': 10.0,     // ÁÇ≠Èªë - ÊúÄÈ´òÈÅÆÁõñÂäõ
    'iron_oxide_red': 7.0,    // Ê∞ßÂåñÈìÅÁ∫¢ - È´òÈÅÆÁõñÂäõ
    'iron_oxide_yellow': 6.5, // Ê∞ßÂåñÈìÅÈªÑ - ‰∏≠È´òÈÅÆÁõñÂäõ
    'ultramarine_blue': 7.5,  // Áæ§ÈùíËìù - È´òÈÅÆÁõñÂäõ
    'phthalocyanine_blue': 4.0, // ÈÖûËèÅËìù - ‰∏≠Á≠âÈÅÆÁõñÂäõ
    'phthalocyanine_green': 3.5, // ÈÖûËèÅÁªø - ‰∏≠Á≠âÈÅÆÁõñÂäõ
    'quinacridone_violet': 3.0  // ÂñπÂêñÂï∂ÈÖÆÁ¥´ - ËæÉ‰ΩéÈÅÆÁõñÂäõ
};

const PIGMENT_NAMES = {
    'titanium_white': { zh: 'ÈíõÁôΩÁ≤â', en: 'Titanium White', ja: '„ÉÅ„Çø„É≥„Éõ„ÉØ„Ç§„Éà' },
    'carbon_black': { zh: 'ÁÇ≠Èªë', en: 'Carbon Black', ja: '„Ç´„Éº„Éú„É≥„Éñ„É©„ÉÉ„ÇØ' },
    'iron_oxide_red': { zh: 'Ê∞ßÂåñÈìÅÁ∫¢', en: 'Iron Oxide Red', ja: 'ÈÖ∏ÂåñÈâÑ„É¨„ÉÉ„Éâ' },
    'iron_oxide_yellow': { zh: 'Ê∞ßÂåñÈìÅÈªÑ', en: 'Iron Oxide Yellow', ja: 'ÈÖ∏ÂåñÈâÑ„Ç§„Ç®„É≠„Éº' },
    'ultramarine_blue': { zh: 'Áæ§ÈùíËìù', en: 'Ultramarine Blue', ja: '„Ç¶„É´„Éà„É©„Éû„É™„É≥„Éñ„É´„Éº' },
    'phthalocyanine_blue': { zh: 'ÈÖûËèÅËìù', en: 'Phthalocyanine Blue', ja: '„Éï„Çø„É≠„Ç∑„Ç¢„Éã„É≥„Éñ„É´„Éº' },
    'phthalocyanine_green': { zh: 'ÈÖûËèÅÁªø', en: 'Phthalocyanine Green', ja: '„Éï„Çø„É≠„Ç∑„Ç¢„Éã„É≥„Ç∞„É™„Éº„É≥' },
    'quinacridone_violet': { zh: 'ÂñπÂêñÂï∂ÈÖÆÁ¥´', en: 'Quinacridone Violet', ja: '„Ç≠„Éä„ÇØ„É™„Éâ„É≥„Éê„Ç§„Ç™„É¨„ÉÉ„Éà' }
};

const UNITS = {
    parts: { zh: '‰ªΩ', en: 'parts', ja: 'ÈÉ®' },
    grams: { zh: 'g', en: 'g', ja: 'g' },
    total_weight: { zh: 'ÊÄªÈáçÈáè', en: 'Total Weight', ja: 'Á∑èÈáçÈáè' }
};

// ======================== ‰øÆÂ§çÂêéÁöÑÈÖçÊñπËÆ°ÁÆóÂáΩÊï∞ ========================
function calculateOptimizedRecipe(L, a, b) {
    const recipe = {};
    
    // ËÆ°ÁÆóËâ≤Â∫¶ÂíåËâ≤Áõ∏
    const chroma = Math.sqrt(a * a + b * b);
    const hue = Math.atan2(b, a) * 180 / Math.PI;
    const normalizedHue = hue < 0 ? hue + 360 : hue;
    
    // Âü∫Á°ÄÈÖçÊñπËÆ°ÁÆó
    let baseIntensity = Math.min(chroma / 80, 1.0); // Ê†áÂáÜÂåñËâ≤Â∫¶Âº∫Â∫¶
    
    // ÊòéÂ∫¶Ë∞ÉÊï¥ - ‰øÆÂ§çÁôΩËâ≤ÂíåÈªëËâ≤Áî®Èáè
    if (L < 20) {
        // Ê∑±Ëâ≤Á≥ª - ÂáèÂ∞ëÈªëËâ≤Áî®ÈáèÔºåËÄÉËôëÈÅÆÁõñÂäõ
        const blackAmount = Math.max(0.1, (20 - L) / 20 * 2.0); // ÊúÄÂ§ß2%
        recipe.carbon_black = Math.round(blackAmount * 10) / 10;
    } else if (L > 85) {
        // ÊµÖËâ≤Á≥ª - ÈÄÇÈáèÁôΩËâ≤ÔºåÈÅøÂÖçËøáÂ∫¶Á®ÄÈáä
        const whiteAmount = Math.max(0.2, (L - 85) / 15 * 1.5); // ÊúÄÂ§ß1.5%
        recipe.titanium_white = Math.round(whiteAmount * 10) / 10;
    }
    
    // Ëâ≤Áõ∏ÈÖçÊñπ - Âü∫‰∫é‰∏ì‰∏öË∞ÉËâ≤ÁªèÈ™å
    if (normalizedHue >= 0 && normalizedHue < 60) {
        // Á∫¢-ÈªÑÂå∫Âüü
        const redRatio = (60 - normalizedHue) / 60;
        const yellowRatio = normalizedHue / 60;
        
        if (redRatio > 0.1) {
            recipe.iron_oxide_red = Math.round(redRatio * baseIntensity * 4.0 * 10) / 10;
        }
        if (yellowRatio > 0.1) {
            recipe.iron_oxide_yellow = Math.round(yellowRatio * baseIntensity * 3.5 * 10) / 10;
        }
    } else if (normalizedHue >= 60 && normalizedHue < 180) {
        // ÈªÑ-Áªø-ÈùíÂå∫Âüü
        if (normalizedHue < 120) {
            // ÈªÑ-Áªø
            const yellowRatio = (120 - normalizedHue) / 60;
            const greenRatio = (normalizedHue - 60) / 60;
            
            if (yellowRatio > 0.1) {
                recipe.iron_oxide_yellow = Math.round(yellowRatio * baseIntensity * 3.5 * 10) / 10;
            }
            if (greenRatio > 0.1) {
                recipe.phthalocyanine_green = Math.round(greenRatio * baseIntensity * 2.5 * 10) / 10;
            }
        } else {
            // Áªø-Èùí
            const greenRatio = (180 - normalizedHue) / 60;
            const blueRatio = (normalizedHue - 120) / 60;
            
            if (greenRatio > 0.1) {
                recipe.phthalocyanine_green = Math.round(greenRatio * baseIntensity * 2.5 * 10) / 10;
            }
            if (blueRatio > 0.1) {
                recipe.phthalocyanine_blue = Math.round(blueRatio * baseIntensity * 2.0 * 10) / 10;
            }
        }
    } else if (normalizedHue >= 180 && normalizedHue < 300) {
        // Èùí-Ëìù-Á¥´Âå∫Âüü
        if (normalizedHue < 240) {
            // Èùí-Ëìù
            const cyanRatio = (240 - normalizedHue) / 60;
            const blueRatio = (normalizedHue - 180) / 60;
            
            if (cyanRatio > 0.1) {
                recipe.phthalocyanine_blue = Math.round(cyanRatio * baseIntensity * 2.0 * 10) / 10;
            }
            if (blueRatio > 0.1) {
                recipe.ultramarine_blue = Math.round(blueRatio * baseIntensity * 3.0 * 10) / 10;
            }
        } else {
            // Ëìù-Á¥´
            const blueRatio = (300 - normalizedHue) / 60;
            const violetRatio = (normalizedHue - 240) / 60;
            
            if (blueRatio > 0.1) {
                recipe.ultramarine_blue = Math.round(blueRatio * baseIntensity * 3.0 * 10) / 10;
            }
            if (violetRatio > 0.1) {
                recipe.quinacridone_violet = Math.round(violetRatio * baseIntensity * 2.8 * 10) / 10;
            }
        }
    } else {
        // Á¥´-Á∫¢Âå∫Âüü (300-360)
        const violetRatio = (360 - normalizedHue) / 60;
        const redRatio = (normalizedHue - 300) / 60;
        
        if (violetRatio > 0.1) {
            recipe.quinacridone_violet = Math.round(violetRatio * baseIntensity * 2.8 * 10) / 10;
        }
        if (redRatio > 0.1) {
            recipe.iron_oxide_red = Math.round(redRatio * baseIntensity * 4.0 * 10) / 10;
        }
    }
    
    // ÁßªÈô§ËøáÂ∞èÁöÑÁî®Èáè
    Object.keys(recipe).forEach(key => {
        if (recipe[key] < 0.1) {
            delete recipe[key];
        }
    });
    
    return recipe;
}

// ËÆ°ÁÆóÈ¢úÊñôÈáçÈáè - Âü∫‰∫éÈÅÆÁõñÂäõÂíåÂÆπÈáè
function calculatePigmentWeight(percentage, volumeMl, pigmentType) {
    const coverage = PIGMENT_COVERAGE[pigmentType] || 5.0;
    const baseDensity = 1.2; // ÈÄèÊòéÂü∫Á°ÄÊºÜÂØÜÂ∫¶ g/ml
    const pigmentDensity = 3.5; // Âπ≥ÂùáÈ¢úÊñôÂØÜÂ∫¶ g/ml
    
    // ËÄÉËôëÈÅÆÁõñÂäõÁöÑÂÆûÈôÖÁî®ÈáèË∞ÉÊï¥
    const adjustedPercentage = percentage / coverage * 5.0;
    const weightGrams = (volumeMl * baseDensity * adjustedPercentage / 100) * (pigmentDensity / baseDensity);
    
    return Math.round(weightGrams * 10) / 10;
}

// ======================== ‰øÆÂ§çÂêéÁöÑËâ≤Â∑ÆËÆ°ÁÆóÂáΩÊï∞ ========================
function calculateDeltaE() {
    try {
        const targetL = parseFloat(document.getElementById('targetL').value);
        const targetA = parseFloat(document.getElementById('targetA').value);
        const targetB = parseFloat(document.getElementById('targetB').value);
        
        const actualL = parseFloat(document.getElementById('actualL').value);
        const actualA = parseFloat(document.getElementById('actualA').value);
        const actualB = parseFloat(document.getElementById('actualB').value);
        
        // ËæìÂÖ•È™åËØÅ
        if (isNaN(targetL) || isNaN(targetA) || isNaN(targetB) || 
            isNaN(actualL) || isNaN(actualA) || isNaN(actualB)) {
            throw new Error('ËØ∑ËæìÂÖ•ÂÆåÊï¥ÁöÑLABÂÄº');
        }
        
        if (targetL < 0 || targetL > 100 || actualL < 0 || actualL > 100) {
            throw new Error('LÂÄºÂøÖÈ°ªÂú®0-100‰πãÈó¥');
        }
        
        if (targetA < -128 || targetA > 127 || actualA < -128 || actualA > 127 ||
            targetB < -128 || targetB > 127 || actualB < -128 || actualB > 127) {
            throw new Error('aÂíåbÂÄºÂøÖÈ°ªÂú®-128Âà∞127‰πãÈó¥');
        }
        
        // CIE76 Delta EËÆ°ÁÆó
        const deltaL = actualL - targetL;
        const deltaA = actualA - targetA;
        const deltaB = actualB - targetB;
        
        const deltaE = Math.sqrt(deltaL * deltaL + deltaA * deltaA + deltaB * deltaB);
        
        // ÊòæÁ§∫ÁªìÊûú
        displayDeltaEResult(deltaE);
        
        // Êõ¥Êñ∞È¢úËâ≤È¢ÑËßà
        updateColorPreview('targetColorPreview', targetL, targetA, targetB);
        updateColorPreview('actualColorPreview', actualL, actualA, actualB);
        
    } catch (error) {
        const resultDiv = document.getElementById('deltaEResult');
        if (resultDiv) {
            const errorTexts = {
                zh: 'ËÆ°ÁÆóÈîôËØØ: ' + error.message,
                en: 'Calculation error: ' + error.message,
                ja: 'Ë®àÁÆó„Ç®„É©„Éº: ' + error.message
            };
            resultDiv.innerHTML = `<div class="delta-e-result delta-e-poor">${errorTexts[currentLanguage]}</div>`;
        }
    }
}

// ÊòæÁ§∫Delta EÁªìÊûú
function displayDeltaEResult(deltaE) {
    const resultDiv = document.getElementById('deltaEResult');
    if (!resultDiv) return;
    
    let className, description;
    
    if (deltaE <= 1.0) {
        className = 'delta-e-excellent';
        description = {
            zh: '‰ºòÁßÄ - ‰∫∫ÁúºÂá†‰πéÊó†Ê≥ïÂØüËßâÂ∑ÆÂºÇ',
            en: 'Excellent - Barely perceptible difference',
            ja: 'ÂÑ™ÁßÄ - ‰∫∫„ÅÆÁõÆ„Åß„ÅØ„Åª„Å®„Çì„Å©Áü•Ë¶ö„Åß„Åç„Å™„ÅÑÂ∑Æ'
        };
    } else if (deltaE <= 2.0) {
        className = 'delta-e-good';
        description = {
            zh: 'ËâØÂ•Ω - ‰ªîÁªÜËßÇÂØüÂèØÂØüËßâÂ∑ÆÂºÇ',
            en: 'Good - Perceptible through close observation',
            ja: 'ËâØÂ•Ω - Ê≥®ÊÑèÊ∑±„ÅèË¶≥ÂØü„Åô„Çã„Å®Áü•Ë¶ö„Åß„Åç„ÇãÂ∑Æ'
        };
    } else if (deltaE <= 3.5) {
        className = 'delta-e-good';
        description = {
            zh: 'ÂèØÊé•Âèó - ‰∏ÄÁúºÂ∞±ËÉΩÂØüËßâÂ∑ÆÂºÇ',
            en: 'Acceptable - Perceptible at a glance',
            ja: 'Ë®±ÂÆπÁØÑÂõ≤ - ‰∏ÄÁõÆ„ÅßÁü•Ë¶ö„Åß„Åç„ÇãÂ∑Æ'
        };
    } else {
        className = 'delta-e-poor';
        description = {
            zh: '‰∏çÂèØÊé•Âèó - ÊòéÊòæÁöÑÈ¢úËâ≤Â∑ÆÂºÇ',
            en: 'Unacceptable - Obvious color difference',
            ja: 'Ë®±ÂÆπ‰∏çÂèØ - Êòé„Çâ„Åã„Å™Ëâ≤„ÅÆÈÅï„ÅÑ'
        };
    }
    
    const deltaETexts = {
        zh: 'Delta E',
        en: 'Delta E',
        ja: 'Delta E'
    };
    
    resultDiv.innerHTML = `
        <div class="delta-e-result ${className}">
            ${deltaETexts[currentLanguage]}: ${Math.round(deltaE * 100) / 100}
        </div>
        <div class="delta-e-info">${description[currentLanguage]}</div>
    `;
}

// ‰ΩøÁî®ÂΩìÂâçÈ¢úËâ≤Â°´ÂÖÖÁõÆÊ†áLABÂÄº
function useCurrentColor() {
    if (!currentColorData) {
        const errorTexts = {
            zh: 'ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™RALÈ¢úËâ≤',
            en: 'Please select a RAL color first',
            ja: 'ÊúÄÂàù„Å´RALËâ≤„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
        };
        alert(errorTexts[currentLanguage]);
        return;
    }
    
    try {
        const labMatch = currentColorData.lab.match(/L:([\d.-]+), a:([\d.-]+), b:([\d.-]+)/);
        if (labMatch) {
            const L = parseFloat(labMatch[1]);
            const a = parseFloat(labMatch[2]);
            const b = parseFloat(labMatch[3]);
            
            document.getElementById('targetL').value = L;
            document.getElementById('targetA').value = a;
            document.getElementById('targetB').value = b;
            
            updateColorPreview('targetColorPreview', L, a, b);
        }
    } catch (error) {
        console.error('‰ΩøÁî®ÂΩìÂâçÈ¢úËâ≤Â§±Ë¥•:', error);
    }
}

// Êõ¥Êñ∞È¢úËâ≤È¢ÑËßà
function updateColorPreview(previewId, L, a, b) {
    const preview = document.getElementById(previewId);
    if (!preview) return;
    
    try {
        const rgb = labToRgb(L, a, b);
        const rgbColor = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
        preview.style.backgroundColor = rgbColor;
        
        // Ëá™ÈÄÇÂ∫îÊñáÂ≠óÈ¢úËâ≤
        const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
        preview.style.color = brightness > 128 ? '#000' : '#fff';
        
        const labText = `L:${Math.round(L*10)/10} a:${Math.round(a*10)/10} b:${Math.round(b*10)/10}`;
        preview.innerHTML = labText;
        
    } catch (error) {
        preview.style.backgroundColor = '#ccc';
        preview.style.color = '#666';
        preview.innerHTML = 'Invalid';
    }
}

// LABÂà∞RGBËΩ¨Êç¢ (‰øÆÂ§çÁâà)
function labToRgb(L, a, b) {
    // LAB to XYZ
    let y = (L + 16) / 116;
    let x = a / 500 + y;
    let z = y - b / 200;
    
    const delta = 6 / 29;
    const deltaSquared = delta * delta;
    const deltaCubed = delta * delta * delta;
    
    x = x > delta ? x * x * x : 3 * deltaSquared * (x - 4 / 29);
    y = y > delta ? y * y * y : 3 * deltaSquared * (y - 4 / 29);
    z = z > delta ? z * z * z : 3 * deltaSquared * (z - 4 / 29);
    
    // D65Ê†áÂáÜÂÖâÊ∫ê
    x *= 95.047;
    y *= 100.000;
    z *= 108.883;
    
    // XYZ to RGB (sRGB)
    let r = x * 3.2406 + y * -1.5372 + z * -0.4986;
    let g = x * -0.9689 + y * 1.8758 + z * 0.0415;
    let bl = x * 0.0557 + y * -0.2040 + z * 1.0570;
    
    // ‰ºΩÈ©¨Ê†°Ê≠£
    r = r > 0.0031308 ? 1.055 * Math.pow(r, 1 / 2.4) - 0.055 : 12.92 * r;
    g = g > 0.0031308 ? 1.055 * Math.pow(g, 1 / 2.4) - 0.055 : 12.92 * g;
    bl = bl > 0.0031308 ? 1.055 * Math.pow(bl, 1 / 2.4) - 0.055 : 12.92 * bl;
    
    // ÈôêÂà∂ËåÉÂõ¥Âπ∂ËΩ¨Êç¢‰∏∫Êï¥Êï∞
    r = Math.max(0, Math.min(255, Math.round(r * 255)));
    g = Math.max(0, Math.min(255, Math.round(g * 255)));
    bl = Math.max(0, Math.min(255, Math.round(bl * 255)));
    
    return { r, g, b: bl };
}

// ======================== ÂÖ∂‰ªñÂäüËÉΩÂáΩÊï∞ ========================
function switchLanguage(lang) {
    currentLanguage = lang;
    
    // Êõ¥Êñ∞ËØ≠Ë®ÄÊåâÈíÆÁä∂ÊÄÅ
    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="switchLanguage('${lang}')"]`).classList.add('active');
    
    // ÊòæÁ§∫/ÈöêËóèÂØπÂ∫îËØ≠Ë®ÄÁöÑÊñáÊú¨
    ['zh', 'en', 'ja'].forEach(l => {
        const elements = document.querySelectorAll(`.${l}`);
        elements.forEach(el => {
            if (l === lang) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        });
    });
    
    // Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÂç†‰ΩçÁ¨¶
    updatePlaceholders();
    
    // Êõ¥Êñ∞ÂÆπÈáèÊòæÁ§∫
    updateVolumeDisplay();
    
    // ÈáçÊñ∞ÁîüÊàêÈ¢úËâ≤ÁΩëÊ†ºÔºàÊõ¥Êñ∞Â∑•ÂÖ∑ÊèêÁ§∫Ôºâ
    generateColorGrid();
}

function updatePlaceholders() {
    const placeholders = {
        zh: 'ËØ∑ËæìÂÖ• RAL Âõõ‰ΩçËâ≤Âè∑',
        en: 'Enter 4-digit RAL code',
        ja: 'RAL 4Ê°Å„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ'
    };
    
    if (ralInput) {
        ralInput.placeholder = placeholders[currentLanguage];
    }
}

function updateVolumeDisplay() {
    const volumeDisplay = document.getElementById('volumeDisplay');
    if (!volumeDisplay || !volumeSelect) return;
    
    const volume = volumeSelect.value;
    const displays = {
        '500': { zh: '500ml', en: '500ml', ja: '500ml' },
        '1000': { zh: '1L (1000ml)', en: '1L (1000ml)', ja: '1L (1000ml)' },
        '5000': { zh: '5L (5000ml)', en: '5L (5000ml)', ja: '5L (5000ml)' },
        '20000': { zh: '20L (20000ml)', en: '20L (20000ml)', ja: '20L (20000ml)' }
    };
    
    volumeDisplay.textContent = displays[volume][currentLanguage];
}

function generateColorGrid() {
    if (!colorGrid) return;
    
    colorGrid.innerHTML = '';
    
    Object.entries(ralPaintMap).forEach(([code, data]) => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = data.rgb;
        swatch.textContent = code;
        swatch.onclick = () => selectColor(code);
        
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.textContent = `RAL ${code} - ${data.name[currentLanguage]}`;
        swatch.appendChild(tooltip);
        
        colorGrid.appendChild(swatch);
    });
}

function selectColor(ralCode) {
    // ÁßªÈô§‰πãÂâçÈÄâ‰∏≠ÁöÑÁä∂ÊÄÅ
    document.querySelectorAll('.color-swatch').forEach(swatch => {
        swatch.classList.remove('selected');
    });
    
    // Ê∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
    event.target.classList.add('selected');
    
    // Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÂíåÊòæÁ§∫
    if (ralInput) ralInput.value = ralCode;
    if (ralSelect) ralSelect.value = ralCode;
    
    displayColorInfo(ralCode);
}

function displayColorInfo(ralCode) {
    const colorData = ralPaintMap[ralCode];
    if (!colorData) {
        showError();
        return;
    }
    
    currentColorData = colorData;
    
    try {
        // ÊòæÁ§∫È¢úËâ≤‰ø°ÊÅØ
        if (colorDisplay) colorDisplay.style.display = 'block';
        if (errorMsg) errorMsg.style.display = 'none';
        
        // Êõ¥Êñ∞È¢úËâ≤È¢ÑËßà
        if (colorPreview) {
            colorPreview.style.backgroundColor = colorData.rgb;
            colorPreview.innerHTML = `RAL ${ralCode}`;
            
            // Ëá™ÈÄÇÂ∫îÊñáÂ≠óÈ¢úËâ≤
            const rgb = hexToRgb(colorData.rgb);
            if (rgb) {
                const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
                colorPreview.style.color = brightness > 128 ? '#000' : '#fff';
            }
        }
        
        // Êõ¥Êñ∞È¢úËâ≤‰ø°ÊÅØ
        const colorInfo = document.getElementById('colorInfo');
        if (colorInfo) {
            const infoTexts = {
                zh: `RAL ${ralCode} - ${colorData.name.zh}<br>RGB: ${colorData.rgb}<br>LAB: ${colorData.lab}`,
                en: `RAL ${ralCode} - ${colorData.name.en}<br>RGB: ${colorData.rgb}<br>LAB: ${colorData.lab}`,
                ja: `RAL ${ralCode} - ${colorData.name.ja}<br>RGB: ${colorData.rgb}<br>LAB: ${colorData.lab}`
            };
            colorInfo.innerHTML = infoTexts[currentLanguage];
        }
        
        // Ëß£ÊûêLABÂÄºÂπ∂ËÆ°ÁÆóÈÖçÊñπ
        const labMatch = colorData.lab.match(/L:([\d.-]+), a:([\d.-]+), b:([\d.-]+)/);
        if (labMatch) {
            const L = parseFloat(labMatch[1]);
            const a = parseFloat(labMatch[2]);
            const b = parseFloat(labMatch[3]);
            
            displayRecipe(L, a, b);
            showDebugInfo(ralCode, L, a, b);
        }
        
    } catch (error) {
        console.error('Display color info error:', error);
        showError();
    }
}

function displayRecipe(L, a, b) {
    if (!recipeList) return;
    
    try {
        const selectedVolume = parseInt(volumeSelect.value);
        const recipe = calculateOptimizedRecipe(L, a, b);
        
        recipeList.innerHTML = '';
        let totalWeight = 0;
        
        for (const [paint, percentage] of Object.entries(recipe)) {
            if (percentage > 0) {
                const li = document.createElement('li');
                const paintName = PIGMENT_NAMES[paint] ? PIGMENT_NAMES[paint][currentLanguage] : paint;
                const partText = UNITS.parts[currentLanguage];
                const weightText = UNITS.grams[currentLanguage];
                const weight = calculatePigmentWeight(percentage, selectedVolume, paint);
                totalWeight += weight;
                
                li.innerHTML = `<span>${paintName}</span><div><span class="paint-weight">${percentage} ${partText}</span><br><span class="paint-weight-grams">${weight} ${weightText}</span></div>`;
                recipeList.appendChild(li);
            }
        }
        
        // Ê∑ªÂä†ÊÄªÈáçÈáè
        if (totalWeight > 0) {
            const totalLi = document.createElement('li');
            totalLi.style.borderTop = '2px solid #3498db';
            totalLi.style.fontWeight = 'bold';
            totalLi.innerHTML = `<span>${UNITS.total_weight[currentLanguage]}</span><span class="paint-weight-grams">${Math.round(totalWeight * 10) / 10}g</span>`;
            recipeList.appendChild(totalLi);
        }
        
    } catch (error) {
        console.error('ÈÖçÊñπÊòæÁ§∫ÈîôËØØ:', error);
        const errorTexts = {
            zh: 'ÈÖçÊñπËÆ°ÁÆóÈîôËØØ',
            en: 'Recipe calculation error',
            ja: 'ÈÖçÂêàË®àÁÆó„Ç®„É©„Éº'
        };
        recipeList.innerHTML = `<li style="color: red;">${errorTexts[currentLanguage]}</li>`;
    }
}

function showDebugInfo(ralCode, L, a, b) {
    const debugInfo = document.getElementById('debugInfo');
    const debugContent = document.getElementById('debugContent');
    if (debugInfo && debugContent) {
        try {
            const recipe = calculateOptimizedRecipe(L, a, b);
            const chroma = Math.sqrt(a * a + b * b);
            const hue = Math.atan2(b, a) * 180 / Math.PI;
            const normalizedHue = hue < 0 ? hue + 360 : hue;
            
            const debugLabels = {
                zh: { ral: 'RAL', lab: 'LAB', chroma: 'Ëâ≤Â∫¶', hue: 'Ëâ≤Áõ∏', recipe: 'ÈÖçÊñπ' },
                en: { ral: 'RAL', lab: 'LAB', chroma: 'Chroma', hue: 'Hue', recipe: 'Recipe' },
                ja: { ral: 'RAL', lab: 'LAB', chroma: 'ÂΩ©Â∫¶', hue: 'Ëâ≤Áõ∏', recipe: 'ÈÖçÂêà' }
            };
            const labels = debugLabels[currentLanguage];
            
            debugContent.innerHTML = `${labels.ral}: ${ralCode}<br>${labels.lab}: L=${L}, a=${a}, b=${b}<br>${labels.chroma}: ${Math.round(chroma * 100) / 100}<br>${labels.hue}: ${Math.round(normalizedHue * 100) / 100}¬∞<br>${labels.recipe}: ${JSON.stringify(recipe, null, 2)}`;
            
            // Ê£ÄÊü•URLÂèÇÊï∞ÊòØÂê¶ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('debug') === 'true') {
                debugInfo.style.display = 'block';
            }
        } catch (error) {
            const errorTexts = {
                zh: 'Ë∞ÉËØï‰ø°ÊÅØÈîôËØØ',
                en: 'Debug info error',
                ja: '„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Ç®„É©„Éº'
            };
            debugContent.innerHTML = `${errorTexts[currentLanguage]}: ${error.message}`;
        }
    }
}

function hideColorInfo() {
    if (colorDisplay) colorDisplay.style.display = 'none';
    if (errorMsg) errorMsg.style.display = 'none';
    if (colorPreview) {
        colorPreview.style.backgroundColor = '#ccc';
        const previewTexts = {
            zh: 'ËæìÂÖ•Ëâ≤Âè∑ÊàñÈÄâÊã©Ëâ≤ÂùóËøõË°åÊü•ËØ¢',
            en: 'Enter color code or select color swatch',
            ja: 'Ëâ≤Áï™Âè∑„ÇíÂÖ•Âäõ„Åô„Çã„ÅãËâ≤Ë¶ãÊú¨„ÇíÈÅ∏Êäû'
        };
        colorPreview.innerHTML = previewTexts[currentLanguage];
    }
    currentColorData = null;
}

function showError() {
    if (colorDisplay) colorDisplay.style.display = 'none';
    if (errorMsg) errorMsg.style.display = 'block';
    if (colorPreview) {
        colorPreview.style.backgroundColor = '#e74c3c';
        const errorTexts = {
            zh: 'Êú™ÊâæÂà∞ËØ• RAL Ëâ≤Âè∑',
            en: 'RAL color code not found',
            ja: 'RALËâ≤Áï™Âè∑„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'
        };
        colorPreview.innerHTML = errorTexts[currentLanguage];
    }
    currentColorData = null;
}

function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function populateRalSelect() {
    if (!ralSelect) return;
    
    // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°πÔºà‰øùÁïôÁ¨¨‰∏Ä‰∏™ÈªòËÆ§ÈÄâÈ°πÔºâ
    while (ralSelect.children.length > 1) {
        ralSelect.removeChild(ralSelect.lastChild);
    }
    
    // Ê∑ªÂä†RALÈ¢úËâ≤ÈÄâÈ°π
    Object.entries(ralPaintMap).forEach(([code, data]) => {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = `RAL ${code} - ${data.name[currentLanguage]}`;
        ralSelect.appendChild(option);
    });
}

function initializePage() {
    try {
        // Ëé∑ÂèñDOMÂÖÉÁ¥†ÂºïÁî®
        ralInput = document.getElementById('ralInput');
        ralSelect = document.getElementById('ralSelect');
        volumeSelect = document.getElementById('volumeSelect');
        colorPreview = document.getElementById('colorPreview');
        colorDisplay = document.getElementById('colorDisplay');
        errorMsg = document.getElementById('errorMsg');
        recipeList = document.getElementById('recipeList');
        colorGrid = document.getElementById('colorGrid');
        
        // Ê£ÄÊü•ÂøÖË¶ÅÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
        if (!ralInput || !ralSelect || !volumeSelect || !colorPreview) {
            console.error('ÂÖ≥ÈîÆDOMÂÖÉÁ¥†Êú™ÊâæÂà∞');
            return;
        }
        
        // ÂàùÂßãÂåñÁïåÈù¢
        updatePlaceholders();
        updateVolumeDisplay();
        populateRalSelect();
        generateColorGrid();
        setupEventListeners();
        
        console.log('È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
        
    } catch (error) {
        console.error('È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•:', error);
    }
}

function setupEventListeners() {
    try {
        // RALËæìÂÖ•Ê°Ü‰∫ã‰ª∂
        if (ralInput) {
            ralInput.addEventListener('input', function() {
                const value = this.value.trim().toUpperCase();
                if (/^\d{4}$/.test(value)) {
                    displayColorInfo(value);
                    if (ralSelect) ralSelect.value = value;
                } else {
                    hideColorInfo();
                    if (ralSelect) ralSelect.value = '';
                }
            });
            
            ralInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const value = this.value.trim().toUpperCase();
                    if (/^\d{4}$/.test(value)) {
                        displayColorInfo(value);
                    }
                }
            });
        }
        
        // RAL‰∏ãÊãâËèúÂçï‰∫ã‰ª∂
        if (ralSelect) {
            ralSelect.addEventListener('change', function() {
                const selectedValue = this.value;
                if (selectedValue) {
                    if (ralInput) ralInput.value = selectedValue;
                    displayColorInfo(selectedValue);
                } else {
                    if (ralInput) ralInput.value = '';
                    hideColorInfo();
                }
            });
        }
        
        // ÂÆπÈáèÈÄâÊã©‰∫ã‰ª∂
        if (volumeSelect) {
            volumeSelect.addEventListener('change', function() {
                updateVolumeDisplay();
                if (ralInput && ralInput.value.trim()) {
                    const currentRal = ralInput.value.trim();
                    if (/^\d{4}$/.test(currentRal)) {
                        displayColorInfo(currentRal);
                    }
                }
            });
        }
        
        // LABËæìÂÖ•Ê°Ü‰∫ã‰ª∂ (‰øÆÂ§çÁâà)
        const labInputs = ['targetL', 'targetA', 'targetB', 'actualL', 'actualA', 'actualB'];
        labInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', function() {
                    const isTarget = id.startsWith('target');
                    const previewId = isTarget ? 'targetColorPreview' : 'actualColorPreview';
                    const lInput = document.getElementById(isTarget ? 'targetL' : 'actualL');
                    const aInput = document.getElementById(isTarget ? 'targetA' : 'actualA');
                    const bInput = document.getElementById(isTarget ? 'targetB' : 'actualB');
                    
                    if (lInput && aInput && bInput) {
                        const L = parseFloat(lInput.value);
                        const a = parseFloat(aInput.value);
                        const b = parseFloat(bInput.value);
                        
                        if (!isNaN(L) && !isNaN(a) && !isNaN(b)) {
                            updateColorPreview(previewId, L, a, b);
                        }
                    }
                });
            }
        });
        
        console.log('‰∫ã‰ª∂ÁõëÂê¨Âô®ËÆæÁΩÆÂÆåÊàê');
    } catch (error) {
        console.error('‰∫ã‰ª∂ÁõëÂê¨Âô®ËÆæÁΩÆÂ§±Ë¥•:', error);
        return false;
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
window.addEventListener('DOMContentLoaded', function() {
    initializePage();
});

// Â§áÁî®ÂàùÂßãÂåñÔºàÈò≤Ê≠¢DOMContentLoadedÂ∑≤ÁªèËß¶ÂèëÔºâ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });
} else {
    initializePage();
}

// ÂÖ®Â±ÄÂáΩÊï∞Êö¥Èú≤Ôºà‰æõHTML‰∏≠ÁöÑonclick‰ΩøÁî®Ôºâ
window.switchLanguage = switchLanguage;
window.selectColor = selectColor;
window.displayColorInfo = displayColorInfo;
window.calculateDeltaE = calculateDeltaE;
window.useCurrentColor = useCurrentColor;

// Ë∞ÉËØïÂáΩÊï∞ÔºàÂèØÂú®ÊéßÂà∂Âè∞‰ΩøÁî®Ôºâ
window.debugColorTool = function() {
    console.log('RALÈ¢úËâ≤Êï∞ÊçÆ:', ralPaintMap);
    console.log('ÂΩìÂâçËØ≠Ë®Ä:', currentLanguage);
    console.log('ÂΩìÂâçÈ¢úËâ≤Êï∞ÊçÆ:', currentColorData);
    console.log('DOMÂÖÉÁ¥†Áä∂ÊÄÅ:', {
        ralInput: !!ralInput,
        ralSelect: !!ralSelect,
        volumeSelect: !!volumeSelect,
        colorPreview: !!colorPreview,
        colorDisplay: !!colorDisplay,
        errorMsg: !!errorMsg,
        recipeList: !!recipeList,
        colorGrid: !!colorGrid
    });
};

</script>
</body>
</html>
