<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MooCow Mini 调色工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2A58D1',
            secondary: '#F4C430',
            accent: '#B91D23',
            neutral: '#F5F7FA',
            dark: '#333333',
            enText: '#666666',
            paint: {
              yellow: '#F4C430',
              red: '#B91D23',
              black: '#000000',
              white: '#FFFFFF',
              blue: '#2A58D1',
              green: '#229954',
              orange: '#FF7F00',
              purple: '#800080',
              brown: '#8B4513'
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .shadow-soft { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
      .slider-thumb { @apply appearance-none w-6 h-6 md:w-5 md:h-5 rounded-full cursor-pointer transition-all duration-200 hover:scale-125; }
      .transition-custom { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
      .paint-dot { @apply w-4 h-4 rounded-full border border-gray-300 mr-2; }
      .en { @apply text-sm text-enText ml-1; }
      .pulse-light { animation: pulse-light 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
      .slide-up { animation: slide-up 0.3s ease-out forwards; }
      .fade-in { animation: fade-in 0.3s ease-out forwards; }
    }
    
    @keyframes pulse-light {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    @keyframes slide-up {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* 颜料滑块样式 */
    #sliderY83S::-webkit-slider-thumb { @apply slider-thumb bg-paint-yellow; }
    #sliderY74S::-webkit-slider-thumb { @apply slider-thumb bg-paint-yellow; }
    #sliderB150S::-webkit-slider-thumb { @apply slider-thumb bg-paint-blue; }
    #sliderB153S::-webkit-slider-thumb { @apply slider-thumb bg-paint-blue; }
    #sliderR254D::-webkit-slider-thumb { @apply slider-thumb bg-paint-red; }
    #sliderR101Y::-webkit-slider-thumb { @apply slider-thumb bg-paint-red; }
    #sliderR101V::-webkit-slider-thumb { @apply slider-thumb bg-paint-red; }
    #sliderY42S::-webkit-slider-thumb { @apply slider-thumb bg-paint-yellow; }
    #slider073::-webkit-slider-thumb { @apply slider-thumb bg-paint-orange; }
    #sliderW064::-webkit-slider-thumb { @apply slider-thumb bg-paint-white border border-gray-300; }
    #sliderV23::-webkit-slider-thumb { @apply slider-thumb bg-paint-purple; }
    #sliderG7::-webkit-slider-thumb { @apply slider-thumb bg-paint-green; }
    #sliderR122S::-webkit-slider-thumb { @apply slider-thumb bg-paint-red; }
    #sliderBK7H::-webkit-slider-thumb { @apply slider-thumb bg-paint-black; }
    
    input[type="range"] {
      @apply appearance-none w-full h-2 md:h-2.5 rounded-full bg-gray-200 outline-none;
    }
    
    /* 重量显示样式 */
    .weight-display {
      @apply font-medium transition-all duration-300;
    }
    .weight-display.white {
      @apply text-gray-800 border border-gray-300 px-1.5 rounded;
      text-shadow: 0 0 1px rgba(0,0,0,0.2);
    }
    
    /* 指导提示样式 */
    .guide-tooltip {
      @apply absolute bg-primary/95 text-white text-xs py-1 px-2 rounded shadow-lg z-50 max-w-[200px] pointer-events-none opacity-0 transition-opacity duration-300;
    }
    
    /* 语言切换按钮样式 */
    .lang-btn {
      @apply px-3 py-1.5 text-sm font-medium rounded-lg transition-all duration-200 border border-gray-200;
    }
    .lang-btn.active {
      @apply bg-primary text-white border-primary;
    }
    .lang-btn:not(.active) {
      @apply bg-white text-gray-600 hover:bg-gray-50;
    }
    
    /* 移动端优化 */
    @media (max-width: 768px) {
      .slider-thumb { @apply w-7 h-7; }
      input[type="range"] { @apply h-3; }
    }
  </style>
</head>

<body class="bg-neutral font-sans text-dark min-h-screen py-4 md:py-8 px-4 md:px-6">
  <!-- 主容器 -->
  <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-soft overflow-hidden">
    <!-- 头部 -->
    <div class="bg-primary text-white p-6 md:p-8 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
      <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
      
      <div class="relative z-10 flex items-center justify-between flex-wrap gap-2">
        <div class="flex items-center gap-3">
          <!-- 牛图标 -->
          <svg class="w-10 h-10" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M50 10C30 10 15 30 15 50C15 70 30 90 50 90C70 90 85 70 85 50C85 30 70 10 50 10ZM50 75C40 75 30 65 30 55H40C40 60 45 65 50 65C55 65 60 60 60 55H70C70 65 60 75 50 75ZM30 45C30 35 40 25 50 25C60 25 70 35 70 45H60C60 40 55 35 50 35C45 35 40 40 40 45H30Z" fill="white"/>
          </svg>
          <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold">MooCow Mini</h1>
        </div>
        
        <div class="flex items-center gap-3">
          <span class="text-white/80 text-sm md:text-base" data-i18n="subtitle">调色工具</span>
          
          <!-- 语言切换按钮 -->
          <div class="flex gap-1 bg-white/10 rounded-lg p-1">
            <button class="lang-btn active" data-lang="zh" title="中文">中</button>
            <button class="lang-btn" data-lang="en" title="English">EN</button>
            <button class="lang-btn" data-lang="ja" title="日本語">日</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 主内容 -->
    <div class="p-6 md:p-8 space-y-8">
      <!-- 1. 目标颜色选择 -->
      <section class="space-y-4">
        <div class="flex items-center gap-2 text-primary font-bold">
          <span class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-sm">1</span>
          <h2 class="text-lg" data-i18n="target_color_selection">目标颜色选择</h2>
          <button id="helpBtn1" class="ml-2 text-gray-400 hover:text-primary transition-colors">
            <i class="fa fa-question-circle"></i>
            <span class="guide-tooltip" data-i18n="help_target_color">选择您想要调色的目标颜色</span>
          </button>
        </div>
        
        <div class="bg-neutral rounded-xl p-4 md:p-5 space-y-4">
          <!-- 快速选择区域 -->
          <div class="space-y-2">
            <h3 class="text-sm font-medium text-gray-700" data-i18n="quick_selection">
              快速选择
            </h3>
            <div class="flex flex-wrap gap-2" id="quickRalContainer">
              <!-- 快速RAL代码将由JS动态生成 -->
            </div>
          </div>
          
          <div class="flex flex-col md:flex-row gap-5">
            <!-- 颜色预览 -->
            <div class="w-full md:w-24 h-24 md:h-auto rounded-lg border-2 border-gray-200 overflow-hidden shadow-sm relative group" id="colorPreview">
              <div class="w-full h-full bg-primary transition-colors duration-500" id="colorSwatch"></div>
              <button class="absolute bottom-1 right-1 w-6 h-6 bg-white/80 rounded-full flex items-center justify-center text-primary opacity-0 group-hover:opacity-100 transition-opacity" id="favoriteBtn">
                <i class="fa fa-star-o text-xs"></i>
              </button>
            </div>
            
            <!-- 颜色选择控件 -->
            <div class="flex-1 space-y-3">
              <div>
                <label for="ralSearch" class="block text-sm text-gray-600 mb-1" data-i18n="ral_search_label">
                  RAL代码搜索（例：5012/7035/8017）
                </label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                    <i class="fa fa-search"></i>
                  </span>
                  <input 
                    type="text" 
                    id="ralSearch" 
                    data-i18n-placeholder="ral_search_placeholder"
                    placeholder="输入RAL代码或颜色名称" 
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom"
                  >
                  <div id="searchSuggestions" class="absolute left-0 right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-soft z-10 max-h-60 overflow-y-auto hidden"></div>
                </div>
              </div>
              
              <div>
                <label for="ralSelect" class="block text-sm text-gray-600 mb-1" data-i18n="ral_select_label">
                  RAL代码选择（215色）
                </label>
                <select 
                  id="ralSelect" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom appearance-none bg-white"
                >
                  <option value="" data-i18n="select_ral_code">选择RAL代码</option>
                </select>
              </div>
              
              <!-- 最近使用的代码 -->
              <div id="recentlyUsedContainer" class="hidden">
                <h3 class="text-sm font-medium text-gray-700 mb-1" data-i18n="recently_used">
                  最近使用
                </h3>
                <div class="flex flex-wrap gap-2" id="recentlyUsedRals">
                  <!-- 最近使用的RAL代码将由JS动态生成 -->
                </div>
              </div>
              
              <!-- 数据显示 -->
              <div class="text-sm text-gray-600 flex flex-wrap gap-x-4 gap-y-1">
                <span data-i18n="current_ral">当前RAL: <span id="currentRalCode" class="font-medium text-primary">未选择</span></span>
                <span data-i18n="color_value">颜色值: <span id="currentHex" class="font-medium text-primary">#2A58D1</span></span>
              </div>
            </div>
          </div>
          
          <!-- 提示 -->
          <div class="flex items-center gap-3 bg-primary/5 p-3 rounded-lg flex-wrap">
            <svg class="w-8 h-8 text-primary" viewBox="0 0 100 100" fill="currentColor">
              <path d="M50 10C30 10 15 30 15 50C15 70 30 90 50 90C70 90 85 70 85 50C85 30 70 10 50 10ZM50 75C40 75 30 65 30 55H40C40 60 45 65 50 65C55 65 60 60 60 55H70C70 65 60 75 50 75ZM30 45C30 35 40 25 50 25C60 25 70 35 70 45H60C60 40 55 35 50 35C45 35 40 40 40 45H30Z"/>
            </svg>
            <p class="text-sm text-gray-700">
              <i class="fa fa-lightbulb-o mr-1 text-secondary"></i> 
              <span data-i18n="color_tip">提示：输入颜色编号（如7035）或颜色描述（如"浅灰色"）可快速找到所需颜色</span>
            </p>
          </div>
        </div>
      </section>
      
      <!-- 2. 颜料重量调节 -->
      <section class="space-y-4">
        <div class="flex items-center gap-2 text-primary font-bold">
          <span class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-sm">2</span>
          <h2 class="text-lg" data-i18n="paint_weight_adjustment">颜料重量调节（14种基础色）</h2>
          <button id="helpBtn2" class="ml-2 text-gray-400 hover:text-primary transition-colors">
            <i class="fa fa-question-circle"></i>
            <span class="guide-tooltip" data-i18n="help_paint_weight">调节各颜料用量，实时查看混合效果</span>
          </button>
        </div>
        
        <div class="bg-neutral rounded-xl p-4 md:p-5 space-y-5">
          <!-- 容量选择 -->
          <div class="flex items-center gap-3 flex-wrap">
            <label for="volumeSelect" class="text-sm text-gray-600 w-24" data-i18n="volume_selection">
              容量选择:
            </label>
            <select 
              id="volumeSelect" 
              class="flex-1 max-w-[200px] px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom appearance-none bg-white"
            >
              <option value="500ml">500ML清漆</option>
              <option value="1l" selected>1L清漆</option>
              <option value="5l">5L清漆</option>
              <option value="20l">20L清漆</option>
            </select>
            <span class="text-sm text-gray-500" data-i18n="volume_hint">
              （选择后自动计算所需颜料重量）
            </span>
          </div>
          
          <!-- 颜料滑块 -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- 金黄颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderY83S" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-yellow"></span>
                  <span data-i18n="paint_y83s">金黄（Y83S）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-yellow hover:bg-paint-yellow/10 rounded-full" data-paint="Y83S" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueY83S" class="weight-display text-paint-yellow min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-yellow hover:bg-paint-yellow/10 rounded-full" data-paint="Y83S" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderY83S" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="Y83S"
              >
            </div>
            
            <!-- 中黄颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderY74S" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-yellow"></span>
                  <span data-i18n="paint_y74s">中黄（Y74S）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-yellow hover:bg-paint-yellow/10 rounded-full" data-paint="Y74S" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueY74S" class="weight-display text-paint-yellow min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-yellow hover:bg-paint-yellow/10 rounded-full" data-paint="Y74S" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderY74S" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="Y74S"
              >
            </div>
            
            <!-- 宝蓝颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderB150S" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-blue"></span>
                  <span data-i18n="paint_b150s">宝蓝（B150S）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-blue hover:bg-paint-blue/10 rounded-full" data-paint="B150S" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueB150S" class="weight-display text-paint-blue min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-blue hover:bg-paint-blue/10 rounded-full" data-paint="B150S" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderB150S" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="B150S"
              >
            </div>
            
            <!-- 艳蓝颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderB153S" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-blue"></span>
                  <span data-i18n="paint_b153s">艳蓝（B153S）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-blue hover:bg-paint-blue/10 rounded-full" data-paint="B153S" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueB153S" class="weight-display text-paint-blue min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-blue hover:bg-paint-blue/10 rounded-full" data-paint="B153S" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderB153S" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="B153S"
              >
            </div>
            
            <!-- 大红颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderR254D" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-red"></span>
                  <span data-i18n="paint_r254d">大红（R254D）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-red hover:bg-paint-red/10 rounded-full" data-paint="R254D" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueR254D" class="weight-display text-paint-red min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-red hover:bg-paint-red/10 rounded-full" data-paint="R254D" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderR254D" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="R254D"
              >
            </div>
            
            <!-- 铁红（黄相）颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderR101Y" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-red"></span>
                  <span data-i18n="paint_r101y">铁红（黄相）（R101Y）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-red hover:bg-paint-red/10 rounded-full" data-paint="R101Y" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueR101Y" class="weight-display text-paint-red min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-red hover:bg-paint-red/10 rounded-full" data-paint="R101Y" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderR101Y" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="R101Y"
              >
            </div>
            
            <!-- 铁红（紫相）颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderR101V" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-red"></span>
                  <span data-i18n="paint_r101v">铁红（紫相）（R101V）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-red hover:bg-paint-red/10 rounded-full" data-paint="R101V" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueR101V" class="weight-display text-paint-red min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-red hover:bg-paint-red/10 rounded-full" data-paint="R101V" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderR101V" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="R101V"
              >
            </div>
            
            <!-- 铁黄颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderY42S" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-yellow"></span>
                  <span data-i18n="paint_y42s">铁黄（Y42S）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-yellow hover:bg-paint-yellow/10 rounded-full" data-paint="Y42S" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueY42S" class="weight-display text-paint-yellow min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-yellow hover:bg-paint-yellow/10 rounded-full" data-paint="Y42S" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderY42S" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="Y42S"
              >
            </div>
            
            <!-- 橙颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="slider073" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-orange"></span>
                  <span data-i18n="paint_073">橙（073）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-orange hover:bg-paint-orange/10 rounded-full" data-paint="073" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="value073" class="weight-display text-paint-orange min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-orange hover:bg-paint-orange/10 rounded-full" data-paint="073" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="slider073" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="073"
              >
            </div>
            
            <!-- 白色颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderW064" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-white"></span>
                  <span data-i18n="paint_w064">白色（W064）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-white hover:bg-paint-white/10 rounded-full" data-paint="W064" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueW064" class="weight-display white min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-white hover:bg-paint-white/10 rounded-full" data-paint="W064" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderW064" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="W064"
              >
            </div>
            
            <!-- 紫色颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderV23" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-purple"></span>
                  <span data-i18n="paint_v23">紫色（V23）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-purple hover:bg-paint-purple/10 rounded-full" data-paint="V23" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueV23" class="weight-display text-paint-purple min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-purple hover:bg-paint-purple/10 rounded-full" data-paint="V23" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderV23" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="V23"
              >
            </div>
            
            <!-- 绿色颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderG7" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-green"></span>
                  <span data-i18n="paint_g7">绿色（G7）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-green hover:bg-paint-green/10 rounded-full" data-paint="G7" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueG7" class="weight-display text-paint-green min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-green hover:bg-paint-green/10 rounded-full" data-paint="G7" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderG7" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="G7"
              >
            </div>
            
            <!-- 玫红颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderR122S" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-red"></span>
                  <span data-i18n="paint_r122s">玫红（R122S）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-red hover:bg-paint-red/10 rounded-full" data-paint="R122S" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueR122S" class="weight-display text-paint-red min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-red hover:bg-paint-red/10 rounded-full" data-paint="R122S" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderR122S" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="R122S"
              >
            </div>
            
            <!-- 黑色颜料 -->
            <div class="space-y-1">
              <div class="flex items-center justify-between mb-1">
                <label for="sliderBK7H" class="text-sm text-gray-700 flex items-center">
                  <span class="paint-dot bg-paint-black"></span>
                  <span data-i18n="paint_bk7h">黑色（BK7H）</span>
                </label>
                <div class="flex items-center gap-1">
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-black hover:bg-paint-black/10 rounded-full" data-paint="BK7H" data-action="decrease">
                    <i class="fa fa-minus text-xs"></i>
                  </button>
                  <span id="valueBK7H" class="weight-display text-paint-black min-w-[40px] text-center">0g</span>
                  <button class="paint-adjust-btn w-5 h-5 flex items-center justify-center text-gray-500 hover:text-paint-black hover:bg-paint-black/10 rounded-full" data-paint="BK7H" data-action="increase">
                    <i class="fa fa-plus text-xs"></i>
                  </button>
                </div>
              </div>
              <input 
                type="range" 
                id="sliderBK7H" 
                min="0" 
                max="1000" 
                value="0" 
                class="cursor-pointer"
                data-paint="BK7H"
              >
            </div>
          </div>
          
          <!-- 颜料比例可视化 -->
          <div class="bg-white p-4 rounded-lg border border-gray-100">
            <h3 class="text-sm font-medium mb-3" data-i18n="paint_ratio">颜料比例</h3>
            <div class="flex flex-col lg:flex-row gap-4">
              <div class="w-full lg:w-1/2 h-[200px]">
                <canvas id="paintChart"></canvas>
              </div>
              <div class="w-full lg:w-1/2 space-y-2">
                <div>
                  <span data-i18n="total_pigment_weight">总颜料重量: </span>
                  <span id="totalPigmentWeight" class="font-medium text-primary">0g</span>
                  <span class="text-xs text-gray-500 ml-2">(<span data-i18n="approx">约 </span><span id="scoopEstimate">0</span> <span data-i18n="standard_spoons">标准勺</span>)</span>
                </div>
                <div>
                  <span data-i18n="varnish_usage">清漆用量: </span>
                  <span id="varnishAmount" class="font-medium text-gray-600">1L</span>
                </div>
                <div>
                  <span data-i18n="per_liter_usage">每升用量: </span>
                  <span id="perLiterAmount" class="font-medium text-gray-600">0g</span>
                </div>
                <div class="text-accent font-medium">
                  <span data-i18n="mixing_ratio">混合比例: 颜料 : 基料 = </span><span id="mixingRatio">0 : 100</span>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex flex-wrap gap-2 mt-2">
                  <button 
                    id="resetFormulaBtn" 
                    class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition-custom flex items-center gap-1"
                  >
                    <i class="fa fa-refresh"></i>
                    <span data-i18n="reset_formula">重置配方</span>
                  </button>
                  <button 
                    id="addFormulaBtn" 
                    class="px-3 py-1.5 bg-secondary text-dark rounded-lg text-sm font-medium hover:bg-secondary/90 transition-custom flex items-center gap-1"
                  >
                    <i class="fa fa-plus-circle"></i>
                    <span data-i18n="add_formula">添加配方</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 配色建议 -->
          <div id="colorSuggestion" class="bg-white p-3 rounded-lg border border-gray-100 hidden">
            <h3 class="text-sm font-medium mb-1 flex items-center">
              <i class="fa fa-lightbulb-o text-secondary mr-1"></i>
              <span data-i18n="color_suggestion">配色建议</span>
            </h3>
            <p class="text-xs text-gray-600" id="suggestionText" data-i18n="suggestion_text">
              为了获得更柔和的色调，建议减少红色用量，增加白色用量。
            </p>
          </div>
        </div>
      </section>
      
      <!-- 3. 包装预览与配方导出 -->
      <section class="space-y-4">
        <div class="flex items-center gap-2 text-primary font-bold">
          <span class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-sm">3</span>
          <h2 class="text-lg" data-i18n="package_preview_export">包装预览与配方导出</h2>
          <button id="helpBtn3" class="ml-2 text-gray-400 hover:text-primary transition-colors">
            <i class="fa fa-question-circle"></i>
            <span class="guide-tooltip" data-i18n="help_package_preview">查看包装效果并导出详细配方</span>
          </button>
        </div>
        
        <div class="bg-neutral rounded-xl p-4 md:p-5 space-y-5">
          <div class="flex flex-col md:flex-row gap-6 items-center md:items-start">
            <!-- 导出按钮 -->
            <div class="w-full md:w-1/3 space-y-3">
              <button 
                id="exportRecipeBtn" 
                class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-custom flex items-center justify-center gap-2 mt-2"
              >
                <i class="fa fa-download"></i>
                <span data-i18n="export_recipe">导出配方（含重量详情）</span>
              </button>
              
              <div class="flex gap-2">
                <button 
                  id="copyRecipeBtn" 
                  class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-custom flex items-center justify-center gap-1 text-sm"
                >
                  <i class="fa fa-copy"></i>
                  <span data-i18n="copy_recipe">复制配方</span>
                </button>
                <button 
                  id="shareRecipeBtn" 
                  class="flex-1 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-custom flex items-center justify-center gap-1 text-sm"
                >
                  <i class="fa fa-share-alt"></i>
                  <span data-i18n="share_recipe">分享</span>
                </button>
              </div>
              
              <div class="bg-white p-3 rounded-lg border border-gray-100">
                <h3 class="text-sm font-medium mb-2" data-i18n="recipe_includes">配方包含:</h3>
                <ul class="text-xs text-gray-600 space-y-1">
                  <li class="flex items-center gap-1"><i class="fa fa-check text-green-500 text-xs"></i> <span data-i18n="ral_color_info">RAL代码和颜色信息</span></li>
                  <li class="flex items-center gap-1"><i class="fa fa-check text-green-500 text-xs"></i> <span data-i18n="paint_weights">各颜料精确重量（含白色）</span></li>
                  <li class="flex items-center gap-1"><i class="fa fa-check text-green-500 text-xs"></i> <span data-i18n="varnish_amount">清漆用量</span></li>
                  <li class="flex items-center gap-1"><i class="fa fa-check text-green-500 text-xs"></i> <span data-i18n="mixing_instructions">混合比例说明</span></li>
                </ul>
              </div>
            </div>
            
            <!-- 包装预览 -->
            <div class="w-full md:w-2/3 flex justify-center">
              <div class="relative" id="canContainer" style="width: 36px; height: 48px;">
                <!-- 罐体 -->
                <div id="canBody" class="absolute inset-0 bg-primary rounded-t-2xl rounded-b-lg border-2 border-dark overflow-hidden transition-all duration-500"></div>
                
                <!-- 罐盖 -->
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[90%] h-6 bg-dark rounded-t-xl border-x-2 border-dark"></div>
                
                <!-- 颜色标签 -->
                <div class="absolute -bottom-10 left-1/2 -translate-x-1/2 bg-white px-2 py-1 rounded shadow text-xs font-medium">
                  <span id="canLabel" data-i18n="ral_code">RAL 代码</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 推荐配方库 -->
          <div>
            <h3 class="text-sm font-medium text-gray-700 mb-2" data-i18n="recommended_recipes">
              推荐配方库
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
              <button class="recipe-preset bg-white border border-gray-200 rounded-lg p-2 text-center text-xs hover:border-primary hover:bg-primary/5 transition-custom" data-ral="7035">
                <div class="w-full h-8 bg-gray-200 rounded mb-1" style="background-color: #D0D0D0;"></div>
                <div data-i18n="industrial_light_gray">工业浅灰</div>
                <div class="text-xs text-gray-500">RAL 7035</div>
              </button>
              <button class="recipe-preset bg-white border border-gray-200 rounded-lg p-2 text-center text-xs hover:border-primary hover:bg-primary/5 transition-custom" data-ral="5005">
                <div class="w-full h-8 bg-blue-700 rounded mb-1" style="background-color: #075F8F;"></div>
                <div data-i18n="signal_blue">信号蓝</div>
                <div class="text-xs text-gray-500">RAL 5005</div>
              </button>
              <button class="recipe-preset bg-white border border-gray-200 rounded-lg p-2 text-center text-xs hover:border-primary hover:bg-primary/5 transition-custom" data-ral="3020">
                <div class="w-full h-8 bg-red-600 rounded mb-1" style="background-color: #E53238;"></div>
                <div data-i18n="traffic_red">交通红</div>
                <div class="text-xs text-gray-500">RAL 3020</div>
              </button>
              <button class="recipe-preset bg-white border border-gray-200 rounded-lg p-2 text-center text-xs hover:border-primary hover:bg-primary/5 transition-custom" data-ral="9002">
                <div class="w-full h-8 bg-gray-100 rounded mb-1" style="background-color: #F5F5F5;"></div>
                <div data-i18n="grey_white">灰白色</div>
                <div class="text-xs text-gray-500">RAL 9002</div>
              </button>
            </div>
          </div>
          
          <!-- 二维码 -->
          <div class="text-center">
            <p class="text-sm text-gray-600 mb-2" data-i18n="scan_qr_code">
              扫描二维码获取完整配方
            </p>
            <div class="inline-flex items-center justify-center w-24 h-24 bg-white p-1 rounded-lg border border-gray-200">
              <svg viewBox="0 0 100 100" class="w-full h-full">
                <rect x="10" y="10" width="20" height="20" fill="#333"/>
                <rect x="10" y="40" width="20" height="20" fill="#333"/>
                <rect x="10" y="70" width="10" height="10" fill="#333"/>
                <rect x="20" y="70" width="10" height="10" fill="white"/>
                <rect x="40" y="10" width="20" height="20" fill="#333"/>
                <rect x="40" y="40" width="20" height="20" fill="white"/>
                <rect x="40" y="70" width="20" height="20" fill="#333"/>
                <rect x="70" y="10" width="10" height="10" fill="#333"/>
                <rect x="80" y="10" width="10" height="10" fill="white"/>
                <rect x="70" y="20" width="20" height="10" fill="#333"/>
                <rect x="70" y="40" width="20" height="20" fill="#333"/>
                <rect x="70" y="70" width="20" height="20" fill="#333"/>
              </svg>
            </div>
          </div>
        </div>
      </section>
    </div>
    
    <!-- 页脚 -->
    <div class="bg-gray-50 border-t border-gray-100 py-4 px-6 text-center text-sm text-gray-500">
      <p data-i18n="footer">MooCow Mini 调色工具 &copy; 2024 | 版本: 2.0.0（优化版）</p>
    </div>
  </div>

  <!-- 指导覆盖层 -->
  <div id="guideOverlay" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-xl relative">
      <button id="closeGuideBtn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        <i class="fa fa-times"></i>
      </button>
      <div class="text-center mb-4">
        <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-magic text-2xl text-primary"></i>
        </div>
        <h3 class="text-lg font-bold text-gray-800" data-i18n="welcome_title">欢迎使用MooCow调色工具</h3>
        <p class="text-gray-600 mt-2" data-i18n="welcome_subtitle">快速学习如何使用工具调出完美颜色</p>
      </div>
      
      <div class="space-y-4 mb-6" id="guideSteps">
        <div class="guide-step active">
          <div class="flex items-start gap-3">
            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center flex-shrink-0 mt-0.5">1</div>
            <div>
              <h4 class="font-medium" data-i18n="guide_step1_title">目标颜色选择</h4>
              <p class="text-sm text-gray-600 mt-1" data-i18n="guide_step1_desc">通过搜索或选择RAL代码找到您想要调色的目标颜色</p>
            </div>
          </div>
        </div>
        <div class="guide-step hidden">
          <div class="flex items-start gap-3">
            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center flex-shrink-0 mt-0.5">2</div>
            <div>
              <h4 class="font-medium" data-i18n="guide_step2_title">颜料比例调节</h4>
              <p class="text-sm text-gray-600 mt-1" data-i18n="guide_step2_desc">使用滑块或微调按钮调节各颜料用量，实时查看混合效果</p>
            </div>
          </div>
        </div>
        <div class="guide-step hidden">
          <div class="flex items-start gap-3">
            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center flex-shrink-0 mt-0.5">3</div>
            <div>
              <h4 class="font-medium" data-i18n="guide_step3_title">配方导出</h4>
              <p class="text-sm text-gray-600 mt-1" data-i18n="guide_step3_desc">调节完成后，导出或分享配方，开始调色</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="flex justify-between">
        <button id="prevGuideBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-custom hidden" data-i18n="prev">
          上一步
        </button>
        <div class="ml-auto">
          <button id="nextGuideBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom" data-i18n="next">
            下一步
          </button>
          <button id="finishGuideBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom hidden" data-i18n="start_using">
            开始使用
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 通知 -->
  <div id="notification" class="fixed bottom-4 right-4 bg-dark text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2 max-w-xs">
    <i class="fa fa-check-circle text-green-400"></i>
    <span id="notificationText">操作成功</span>
  </div>

  <!-- JavaScript 核心逻辑 -->
  <script>
    // 多语言文本配置
    const TRANSLATIONS = {
      zh: {
        subtitle: "调色工具",
        target_color_selection: "目标颜色选择",
        help_target_color: "选择您想要调色的目标颜色",
        quick_selection: "快速选择",
        ral_search_label: "RAL代码搜索（例：5012/7035/8017）",
        ral_search_placeholder: "输入RAL代码或颜色名称",
        ral_select_label: "RAL代码选择（215色）",
        select_ral_code: "选择RAL代码",
        recently_used: "最近使用",
        current_ral: "当前RAL:",
        color_value: "颜色值:",
        color_tip: "提示：输入颜色编号（如7035）或颜色描述（如\"浅灰色\"）可快速找到所需颜色",
        paint_weight_adjustment: "颜料重量调节（14种基础色）",
        help_paint_weight: "调节各颜料用量，实时查看混合效果",
        volume_selection: "容量选择:",
        volume_hint: "（选择后自动计算所需颜料重量）",
        paint_y83s: "金黄（Y83S）",
        paint_y74s: "中黄（Y74S）",
        paint_b150s: "宝蓝（B150S）",
        paint_b153s: "艳蓝（B153S）",
        paint_r254d: "大红（R254D）",
        paint_r101y: "铁红（黄相）（R101Y）",
        paint_r101v: "铁红（紫相）（R101V）",
        paint_y42s: "铁黄（Y42S）",
        paint_073: "橙（073）",
        paint_w064: "白色（W064）",
        paint_v23: "紫色（V23）",
        paint_g7: "绿色（G7）",
        paint_r122s: "玫红（R122S）",
        paint_bk7h: "黑色（BK7H）",
        paint_ratio: "颜料比例",
        total_pigment_weight: "总颜料重量:",
        approx: "约",
        standard_spoons: "标准勺",
        varnish_usage: "清漆用量:",
        per_liter_usage: "每升用量:",
        mixing_ratio: "混合比例: 颜料 : 基料 =",
        reset_formula: "重置配方",
        add_formula: "添加配方",
        color_suggestion: "配色建议",
        suggestion_text: "为了获得更柔和的色调，建议减少红色用量，增加白色用量。",
        package_preview_export: "包装预览与配方导出",
        help_package_preview: "查看包装效果并导出详细配方",
        export_recipe: "导出配方（含重量详情）",
        copy_recipe: "复制配方",
        share_recipe: "分享",
        recipe_includes: "配方包含:",
        ral_color_info: "RAL代码和颜色信息",
        paint_weights: "各颜料精确重量（含白色）",
        varnish_amount: "清漆用量",
        mixing_instructions: "混合比例说明",
        ral_code: "RAL 代码",
        recommended_recipes: "推荐配方库",
        industrial_light_gray: "工业浅灰",
        signal_blue: "信号蓝",
        traffic_red: "交通红",
        grey_white: "灰白色",
        scan_qr_code: "扫描二维码获取完整配方",
        footer: "MooCow Mini 调色工具 © 2024 | 版本: 2.0.0（优化版）",
        welcome_title: "欢迎使用MooCow调色工具",
        welcome_subtitle: "快速学习如何使用工具调出完美颜色",
        guide_step1_title: "目标颜色选择",
        guide_step1_desc: "通过搜索或选择RAL代码找到您想要调色的目标颜色",
        guide_step2_title: "颜料比例调节",
        guide_step2_desc: "使用滑块或微调按钮调节各颜料用量，实时查看混合效果",
        guide_step3_title: "配方导出",
        guide_step3_desc: "调节完成后，导出或分享配方，开始调色",
        prev: "上一步",
        next: "下一步",
        start_using: "开始使用"
      },
      en: {
        subtitle: "Color Mixing Tool",
        target_color_selection: "Target Color Selection",
        help_target_color: "Select the target color you want to mix",
        quick_selection: "Quick Selection",
        ral_search_label: "RAL Code Search (e.g., 5012/7035/8017)",
        ral_search_placeholder: "Enter RAL code or color name",
        ral_select_label: "RAL Code Selection (215 colors)",
        select_ral_code: "Select RAL Code",
        recently_used: "Recently Used",
        current_ral: "Current RAL:",
        color_value: "Color Value:",
        color_tip: "Tip: Enter color number (like 7035) or color description (like \"light gray\") to quickly find the desired color",
        paint_weight_adjustment: "Paint Weight Adjustment (14 Base Colors)",
        help_paint_weight: "Adjust paint amounts and view mixing effects in real time",
        volume_selection: "Volume Selection:",
        volume_hint: "(Automatically calculates required paint weight after selection)",
        paint_y83s: "Golden Yellow (Y83S)",
        paint_y74s: "Medium Yellow (Y74S)",
        paint_b150s: "Royal Blue (B150S)",
        paint_b153s: "Bright Blue (B153S)",
        paint_r254d: "Bright Red (R254D)",
        paint_r101y: "Iron Red (Yellow) (R101Y)",
        paint_r101v: "Iron Red (Purple) (R101V)",
        paint_y42s: "Iron Yellow (Y42S)",
        paint_073: "Orange (073)",
        paint_w064: "White (W064)",
        paint_v23: "Purple (V23)",
        paint_g7: "Green (G7)",
        paint_r122s: "Rose Red (R122S)",
        paint_bk7h: "Black (BK7H)",
        paint_ratio: "Paint Ratio",
        total_pigment_weight: "Total Pigment Weight:",
        approx: "approx",
        standard_spoons: "standard spoons",
        varnish_usage: "Varnish Usage:",
        per_liter_usage: "Per Liter Usage:",
        mixing_ratio: "Mixing Ratio: Pigment : Base =",
        reset_formula: "Reset Formula",
        add_formula: "Add Formula",
        color_suggestion: "Color Suggestion",
        suggestion_text: "For a softer tone, consider reducing red amount and increasing white amount.",
        package_preview_export: "Package Preview & Recipe Export",
        help_package_preview: "View package effect and export detailed recipe",
        export_recipe: "Export Recipe (with weight details)",
        copy_recipe: "Copy Recipe",
        share_recipe: "Share",
        recipe_includes: "Recipe Includes:",
        ral_color_info: "RAL code and color information",
        paint_weights: "Precise weight of each paint (including white)",
        varnish_amount: "Varnish amount",
        mixing_instructions: "Mixing ratio instructions",
        ral_code: "RAL Code",
        recommended_recipes: "Recommended Recipe Library",
        industrial_light_gray: "Industrial Light Gray",
        signal_blue: "Signal Blue",
        traffic_red: "Traffic Red",
        grey_white: "Grey White",
        scan_qr_code: "Scan QR code for complete recipe",
        footer: "MooCow Mini Color Mixing Tool © 2024 | Version: 2.0.0 (Optimized)",
        welcome_title: "Welcome to MooCow Color Mixing Tool",
        welcome_subtitle: "Quickly learn how to use the tool to mix perfect colors",
        guide_step1_title: "Target Color Selection",
        guide_step1_desc: "Find your target color by searching or selecting RAL codes",
        guide_step2_title: "Paint Ratio Adjustment",
        guide_step2_desc: "Use sliders or fine-tune buttons to adjust paint amounts and view mixing effects in real time",
        guide_step3_title: "Recipe Export",
        guide_step3_desc: "After adjustment, export or share the recipe to start color mixing",
        prev: "Previous",
        next: "Next",
        start_using: "Start Using"
      },
      ja: {
        subtitle: "調色ツール",
        target_color_selection: "ターゲット色の選択",
        help_target_color: "調色したいターゲット色を選択してください",
        quick_selection: "クイック選択",
        ral_search_label: "RALコード検索（例：5012/7035/8017）",
        ral_search_placeholder: "RALコードまたは色名を入力",
        ral_select_label: "RALコード選択（215色）",
        select_ral_code: "RALコードを選択",
        recently_used: "最近使用",
        current_ral: "現在のRAL:",
        color_value: "色値:",
        color_tip: "ヒント：色番号（7035など）や色の説明（「ライトグレー」など）を入力すると、必要な色を素早く見つけることができます",
        paint_weight_adjustment: "塗料重量の調整（14種類の基本色）",
        help_paint_weight: "各塗料の使用量を調整し、リアルタイムで混合効果を確認できます",
        volume_selection: "容量選択:",
        volume_hint: "（選択後、必要な塗料重量を自動計算）",
        paint_y83s: "ゴールデンイエロー（Y83S）",
        paint_y74s: "ミディアムイエロー（Y74S）",
        paint_b150s: "ロイヤルブルー（B150S）",
        paint_b153s: "ブライトブルー（B153S）",
        paint_r254d: "ブライトレッド（R254D）",
        paint_r101y: "アイアンレッド（イエロー系）（R101Y）",
        paint_r101v: "アイアンレッド（パープル系）（R101V）",
        paint_y42s: "アイアンイエロー（Y42S）",
        paint_073: "オレンジ（073）",
        paint_w064: "ホワイト（W064）",
        paint_v23: "パープル（V23）",
        paint_g7: "グリーン（G7）",
        paint_r122s: "ローズレッド（R122S）",
        paint_bk7h: "ブラック（BK7H）",
        paint_ratio: "塗料比率",
        total_pigment_weight: "総塗料重量:",
        approx: "約",
        standard_spoons: "標準スプーン",
        varnish_usage: "クリア基材使用量:",
        per_liter_usage: "リットル当たりの使用量:",
        mixing_ratio: "混合比率: 塗料 : 基材 =",
        reset_formula: "配合リセット",
        add_formula: "メリフ配合追加",
        color_suggestion: "配色提案",
        suggestion_text: "より柔らかいトーンにするために、赤の使用量を減らし、白を増やすことをお勧めします。",
        package_preview_export: "パッケージプレビューと配合エクスポート",
        help_package_preview: "パッケージ効果を確認し、詳細な配合をエクスポートできます",
        export_recipe: "配合エクスポート（重量詳細付き）",
        copy_recipe: "配合コピー",
        share_recipe: "シェア",
        recipe_includes: "配合に含まれるもの:",
        ral_color_info: "RALコードと色情報",
        paint_weights: "各塗料の正確な重量（白含む）",
        varnish_amount: "クリア基材使用量",
        mixing_instructions: "混合比率の説明",
        ral_code: "RAL コード",
        recommended_recipes: "推奨配合ライブラリ",
        industrial_light_gray: "工業用ライトグレー",
        signal_blue: "シグナルブルー",
        traffic_red: "トラフィックレッド",
        grey_white: "グレーホワイト",
        scan_qr_code: "完全な配合のQRコードをスキャン",
        footer: "MooCow Mini 調色ツール © 2024 | バージョン: 2.0.0（最適化版）",
        welcome_title: "MooCow 調色ツールへようこそ",
        welcome_subtitle: "ツールを使って完璧な色を調色する方法を素早く学びましょう",
        guide_step1_title: "ターゲット色の選択",
        guide_step1_desc: "検索またはRALコードを選択して、調色したいターゲット色を見つけます",
        guide_step2_title: "塗料比率の調整",
        guide_step2_desc: "スライダーまたは微調整ボタンを使用して各塗料の使用量を調整し、リアルタイムで混合効果を確認します",
        guide_step3_title: "配合のエクスポート",
        guide_step3_desc: "調整完了後、配合をエクスポートまたはシェアして、色の調色を開始します",
        prev: "前へ",
        next: "次へ",
        start_using: "使用開始"
      }
    };

    // 新的颜料数据（基于图片数据）
    const PAINT_DATA = {
      "Y83S": { name: "金黄", name_en: "Golden Yellow", name_ja: "ゴールデンイエロー", L: 82.52, A: 17.29, B: 73.59 },
      "Y74S": { name: "中黄", name_en: "Medium Yellow", name_ja: "ミディアムイエロー", L: 87.77, A: 0.8, B: 72.81 },
      "B150S": { name: "宝蓝", name_en: "Royal Blue", name_ja: "ロイヤルブルー", L: 48.64, A: -5.95, B: -40.42 },
      "B153S": { name: "艳蓝", name_en: "Bright Blue", name_ja: "ブライトブルー", L: 59.36, A: -16.97, B: -38.95 },
      "R254D": { name: "大红", name_en: "Bright Red", name_ja: "ブライトレッド", L: 57.18, A: 49.67, B: 13.26 },
      "R101Y": { name: "铁红（黄相）", name_en: "Iron Red (Yellow)", name_ja: "アイアンレッド（イエロー系）", L: 43.99, A: 32.75, B: 24.57 },
      "R101V": { name: "铁红（紫相）", name_en: "Iron Red (Purple)", name_ja: "アイアンレッド（パープル系）", L: 40.09, A: 28.89, B: 18.77 },
      "Y42S": { name: "铁黄", name_en: "Iron Yellow", name_ja: "アイアンイエロー", L: 80.38, A: 10.64, B: 36.87 },
      "073": { name: "橙", name_en: "Orange", name_ja: "オレンジ", L: 70.43, A: 45.73, B: 27.33 },
      "W064": { name: "白色", name_en: "White", name_ja: "ホワイト", L: 95.23, A: -0.58, B: 0.04 },
      "V23": { name: "紫色", name_en: "Purple", name_ja: "パープル", L: 37.82, A: 18.96, B: -33.68 },
      "G7": { name: "绿色", name_en: "Green", name_ja: "グリーン", L: 62.16, A: -47.51, B: 1.35 },
      "R122S": { name: "玫红", name_en: "Rose Red", name_ja: "ローズレッド", L: 55.54, A: 45.65, B: -16.47 },
      "BK7H": { name: "黑色", name_en: "Black", name_ja: "ブラック", L: 34.26, A: -0.19, B: -2.47 }
    };

    // 当前语言
    let currentLanguage = 'zh';

    // 语言切换功能
    function switchLanguage(lang) {
      currentLanguage = lang;
      
      // 更新语言按钮状态
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.lang === lang) {
          btn.classList.add('active');
        }
      });
      
      // 更新页面语言属性
      document.documentElement.lang = lang === 'zh' ? 'zh-CN' : lang === 'en' ? 'en' : 'ja';
      
      // 更新所有文本
      updateTexts();
      
      // 保存语言偏好
      localStorage.setItem('moocow_language', lang);
    }

    // 更新页面文本
    function updateTexts() {
      const texts = TRANSLATIONS[currentLanguage];
      
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.dataset.i18n;
        if (texts[key]) {
          // 处理包含HTML的文本
          if (key === 'current_ral' || key === 'color_value' || key === 'mixing_ratio') {
            const parts = texts[key].split(':');
            if (parts.length === 2) {
              element.innerHTML = parts[0] + ': ' + element.innerHTML.split(': ')[1];
            }
          } else {
            element.textContent = texts[key];
          }
        }
      });
      
      // 更新placeholder
      document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.dataset.i18nPlaceholder;
        if (texts[key]) {
          element.placeholder = texts[key];
        }
      });
      
      // 更新颜料名称
      updatePaintNames();
      
      // 更新RAL选择器
      updateRalSelect();
    }

    // 更新颜料名称
    function updatePaintNames() {
      Object.keys(PAINT_DATA).forEach(code => {
        const paintInfo = PAINT_DATA[code];
        const element = document.querySelector(`[data-i18n="paint_${code.toLowerCase()}"]`);
        if (element && paintInfo) {
          const nameKey = currentLanguage === 'zh' ? 'name' : 
                         currentLanguage === 'en' ? 'name_en' : 'name_ja';
          element.textContent = `${paintInfo[nameKey]}（${code}）`;
        }
      });
    }

    // DOM元素引用
    const elements = {
      // 颜色选择相关
      ralSearch: document.getElementById('ralSearch'),
      ralSelect: document.getElementById('ralSelect'),
      colorSwatch: document.getElementById('colorSwatch'),
      currentRalCode: document.getElementById('currentRalCode'),
      currentHex: document.getElementById('currentHex'),
      canBody: document.getElementById('canBody'),
      canVolume: document.getElementById('canVolume'),
      canContainer: document.getElementById('canContainer'),
      canLabel: document.getElementById('canLabel'),
      favoriteBtn: document.getElementById('favoriteBtn'),
      searchSuggestions: document.getElementById('searchSuggestions'),
      quickRalContainer: document.getElementById('quickRalContainer'),
      recentlyUsedContainer: document.getElementById('recentlyUsedContainer'),
      recentlyUsedRals: document.getElementById('recentlyUsedRals'),
      
      // 颜料重量相关
      volumeSelect: document.getElementById('volumeSelect'),
      // 新的滑块
      sliderY83S: document.getElementById('sliderY83S'),
      sliderY74S: document.getElementById('sliderY74S'),
      sliderB150S: document.getElementById('sliderB150S'),
      sliderB153S: document.getElementById('sliderB153S'),
      sliderR254D: document.getElementById('sliderR254D'),
      sliderR101Y: document.getElementById('sliderR101Y'),
      sliderR101V: document.getElementById('sliderR101V'),
      sliderY42S: document.getElementById('sliderY42S'),
      slider073: document.getElementById('slider073'),
      sliderW064: document.getElementById('sliderW064'),
      sliderV23: document.getElementById('sliderV23'),
      sliderG7: document.getElementById('sliderG7'),
      sliderR122S: document.getElementById('sliderR122S'),
      sliderBK7H: document.getElementById('sliderBK7H'),
      // 新的重量显示
      valueY83S: document.getElementById('valueY83S'),
      valueY74S: document.getElementById('valueY74S'),
      valueB150S: document.getElementById('valueB150S'),
      valueB153S: document.getElementById('valueB153S'),
      valueR254D: document.getElementById('valueR254D'),
      valueR101Y: document.getElementById('valueR101Y'),
      valueR101V: document.getElementById('valueR101V'),
      valueY42S: document.getElementById('valueY42S'),
      value073: document.getElementById('value073'),
      valueW064: document.getElementById('valueW064'),
      valueV23: document.getElementById('valueV23'),
      valueG7: document.getElementById('valueG7'),
      valueR122S: document.getElementById('valueR122S'),
      valueBK7H: document.getElementById('valueBK7H'),
      // 计算结果
      totalPigmentWeight: document.getElementById('totalPigmentWeight'),
      varnishAmount: document.getElementById('varnishAmount'),
      mixingRatio: document.getElementById('mixingRatio'),
      addFormulaBtn: document.getElementById('addFormulaBtn'),
      resetFormulaBtn: document.getElementById('resetFormulaBtn'),
      perLiterAmount: document.getElementById('perLiterAmount'),
      scoopEstimate: document.getElementById('scoopEstimate'),
      colorSuggestion: document.getElementById('colorSuggestion'),
      suggestionText: document.getElementById('suggestionText'),
      
      // 导出相关
      exportRecipeBtn: document.getElementById('exportRecipeBtn'),
      copyRecipeBtn: document.getElementById('copyRecipeBtn'),
      shareRecipeBtn: document.getElementById('shareRecipeBtn'),
      
      // 帮助和指导
      helpBtn1: document.getElementById('helpBtn1'),
      helpBtn2: document.getElementById('helpBtn2'),
      helpBtn3: document.getElementById('helpBtn3'),
      guideOverlay: document.getElementById('guideOverlay'),
      closeGuideBtn: document.getElementById('closeGuideBtn'),
      nextGuideBtn: document.getElementById('nextGuideBtn'),
      prevGuideBtn: document.getElementById('prevGuideBtn'),
      finishGuideBtn: document.getElementById('finishGuideBtn'),
      guideSteps: document.getElementById('guideSteps'),
      
      // 通知
      notification: document.getElementById('notification'),
      notificationText: document.getElementById('notificationText'),
      
      // 推荐配方
      recipePresets: document.querySelectorAll('.recipe-preset')
    };

    // 常量
    const ADJUST_STEP = 5; // 微调步长
    const VOLUME_FACTORS = {
      '500ml': 0.5,
      '1l': 1,
      '5l': 5,
      '20l': 20
    };

    // 快速RAL代码
    const popularRals = [
      { ral: "7035", name: "浅灰", hex: "#D0D0D0" },
      { ral: "5005", name: "信号蓝", hex: "#075F8F" },
      { ral: "3020", name: "交通红", hex: "#E53238" },
      { ral: "9002", name: "灰白", hex: "#F5F5F5" },
      { ral: "1012", name: "柠檬黄", hex: "#E9E2AC" },
      { ral: "6011", name: "苇绿", hex: "#6C7C59" }
    ];

    // 图表实例
    let paintChart = null;

    // RAL颜色代码数据的生成
    function generateRalPaintMap() {
      // 基础颜色数据
      const baseColors = [
        // 黄色系 (1000-1099)
        { range: [1000, 1027], hue: 'yellow', baseRecipe: { Y83S: 40, Y74S: 30, W064: 30 } },
        // 橙色系 (2000-2099)
        { range: [2000, 2018], hue: 'orange', baseRecipe: { "073": 60, Y74S: 30, R254D: 10 } },
        // 红色系 (3000-3099)
        { range: [3000, 3032], hue: 'red', baseRecipe: { R254D: 50, R101Y: 25, W064: 20, BK7H: 5 } },
        // 紫色系 (4000-4099)
        { range: [4000, 4010], hue: 'purple', baseRecipe: { V23: 65, R122S: 25, B150S: 10 } },
        // 蓝色系 (5000-5099)
        { range: [5000, 5048], hue: 'blue', baseRecipe: { B150S: 40, B153S: 20, W064: 30, BK7H: 10 } },
        // 绿色系 (6000-6099)
        { range: [6000, 6077], hue: 'green', baseRecipe: { G7: 55, Y42S: 35, BK7H: 10 } },
        // 灰色系 (7000-7099) - 大量使用白色
        { range: [7000, 7099], hue: 'grey', baseRecipe: { W064: 80, BK7H: 20 } },
        // 棕色系 (8000-8099)
        { range: [8000, 8040], hue: 'brown', baseRecipe: { R101Y: 40, R101V: 20, Y42S: 25, BK7H: 15 } },
        // 白色/黑色系 (9000-9099) - 主要是白色
        { range: [9000, 9016], hue: 'neutral', baseRecipe: { W064: 90, BK7H: 10 } }
      ];
      
      const ralMap = [];
      const hueNames = {
        yellow: { zh: "黄色", en: "Yellow", ja: "イエロー" },
        orange: { zh: "橙色", en: "Orange", ja: "オレンジ" },
        red: { zh: "红色", en: "Red", ja: "レッド" },
        purple: { zh: "紫色", en: "Purple", ja: "パープル" },
        blue: { zh: "蓝色", en: "Blue", ja: "ブルー" },
        green: { zh: "绿色", en: "Green", ja: "グリーン" },
        grey: { zh: "灰色", en: "Grey", ja: "グレー" },
        brown: { zh: "棕色", en: "Brown", ja: "ブラウン" },
        neutral: { zh: "中性", en: "Neutral", ja: "ニュートラル" }
      };
      
      // 生成各系列的颜色代码
      baseColors.forEach(category => {
        const [start, end] = category.range;
        const { hue, baseRecipe } = category;
        const hueName = hueNames[hue];
        
        // 计算此系列要生成的颜色代码数量
        const count = end - start + 1;
        
        // 生成颜色代码
        for (let i = 0; i < count; i++) {
          const ralCode = (start + i).toString();
          
          // 生成近似的Hex颜色值
          let hex;
          switch(hue) {
            case 'yellow':
              hex = `#F${Math.floor(70 + i * 0.5).toString(16)}C${Math.floor(40 + i * 1).toString(16)}`;
              break;
            case 'orange':
              hex = `#F${Math.floor(80 - i * 1).toString(16)}7${Math.floor(30 + i * 0.5).toString(16)}`;
              break;
            case 'red':
              hex = `#B${Math.floor(90 - i * 1).toString(16)}1${Math.floor(20 + i * 0.3).toString(16)}`;
              break;
            case 'purple':
              hex = `#8${Math.floor(0 + i * 0.5).toString(16)}0${Math.floor(80 - i * 0.5).toString(16)}`;
              break;
            case 'blue':
              hex = `#0${Math.floor(70 + i * 0.3).toString(16)}5${Math.floor(80 - i * 0.5).toString(16)}`;
              break;
            case 'green':
              hex = `#2${Math.floor(20 + i * 0.5).toString(16)}9${Math.floor(50 + i * 0.3).toString(16)}`;
              break;
            case 'grey':
              const greyVal = Math.floor(90 - i * 0.3).toString(16);
              hex = `#${greyVal}${greyVal}${greyVal}`;
              break;
            case 'brown':
              hex = `#A${Math.floor(0 + i * 0.3).toString(16)}5${Math.floor(20 + i * 0.3).toString(16)}`;
              break;
            case 'neutral':
              const neutralVal = Math.floor(90 - i * 5).toString(16);
              hex = `#${neutralVal}${neutralVal}${neutralVal}`;
              break;
            default:
              hex = "#CCCCCC";
          }
          
          // 确保hex值为6位
          if (hex.length < 7) {
            hex = hex.padEnd(7, '0');
          }
          
          // 添加到颜色代码库
          ralMap.push({
            ral: ralCode,
            name_en: `${hueName.en} ${ralCode}`,
            name_zh: `${hueName.zh} ${ralCode}`,
            name_ja: `${hueName.ja} ${ralCode}`,
            hex: hex,
            baseRecipe: { ...baseRecipe }, // 复制基础配方
            recommendedPaints: Object.keys(baseRecipe) // 推荐颜料
          });
        }
      });
      
      // 添加常见的精确颜色代码（特别是大量使用白色的）
      const exactColors = [
        { ral: "1012", name_en: "Lemon yellow", name_zh: "柠檬黄", name_ja: "レモンイエロー", hex: "#E9E2AC", baseRecipe: { Y74S: 60, W064: 40 }, recommendedPaints: ['Y74S', 'W064'] },
        { ral: "5005", name_en: "Signal blue", name_zh: "信号蓝", name_ja: "シグナルブルー", hex: "#075F8F", baseRecipe: { B150S: 50, BK7H: 30, W064: 20 }, recommendedPaints: ['B150S', 'BK7H', 'W064'] },
        { ral: "6011", name_en: "Reseda green", name_zh: "苇绿", name_ja: "レセダグリーン", hex: "#6C7C59", baseRecipe: { G7: 40, Y42S: 30, BK7H: 20, W064: 10 }, recommendedPaints: ['G7', 'Y42S', 'BK7H', 'W064'] },
        { ral: "7016", name_en: "Anthracite grey", name_zh: "炭灰", name_ja: "アントラサイトグレー", hex: "#4F5D75", baseRecipe: { BK7H: 60, W064: 30, B150S: 10 }, recommendedPaints: ['BK7H', 'W064', 'B150S'] },
        { ral: "7035", name_en: "Light grey", name_zh: "浅灰", name_ja: "ライトグレー", hex: "#D0D0D0", baseRecipe: { W064: 92, BK7H: 8 }, recommendedPaints: ['W064', 'BK7H'] },
        { ral: "9001", name_en: "Cream", name_zh: "奶油色", name_ja: "クリーム", hex: "#FFFDD0", baseRecipe: { W064: 95, Y74S: 5 }, recommendedPaints: ['W064', 'Y74S'] },
        { ral: "9002", name_en: "Grey white", name_zh: "灰白", name_ja: "グレーホワイト", hex: "#F5F5F5", baseRecipe: { W064: 98, BK7H: 2 }, recommendedPaints: ['W064', 'BK7H'] },
        { ral: "9005", name_en: "Jet black", name_zh: "纯黑", name_ja: "ジェットブラック", hex: "#000000", baseRecipe: { BK7H: 95, W064: 5 }, recommendedPaints: ['BK7H', 'W064'] }
      ];
      
      // 合并并去重
      return [...exactColors, ...ralMap].filter((item, index, self) => 
        self.findIndex(t => t.ral === item.ral) === index
      ).sort((a, b) => parseInt(a.ral) - parseInt(b.ral));
    }

    // 生成215色RAL颜色代码库
    const ralPaintMap = generateRalPaintMap();
    console.log(`已加载 ${ralPaintMap.length} 种RAL颜色代码`);

    // 当前状态
    let currentState = {
      ral: null,
      volume: '1l',
      volumeFactor: 1,
      favorites: getSavedFavorites(),
      recentlyUsed: getRecentlyUsedRals()
    };

    // 初始化颜料图表
    function initPaintChart() {
      const ctx = document.getElementById('paintChart').getContext('2d');
      paintChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12,
                padding: 8,
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    // 更新颜料图表
    function updatePaintChart() {
      if (!paintChart) return;
      
      const paintCodes = Object.keys(PAINT_DATA);
      const labels = [];
      const data = [];
      const colors = [];
      
      paintCodes.forEach(code => {
        const slider = elements[`slider${code}`];
        const paintInfo = PAINT_DATA[code];
        
        if (slider && paintInfo) {
          const weight = parseInt(slider.value);
          if (weight > 0) {
            const nameKey = currentLanguage === 'zh' ? 'name' : 
                           currentLanguage === 'en' ? 'name_en' : 'name_ja';
            labels.push(`${paintInfo[nameKey]} (${weight}g)`);
            data.push(weight);
            
            // 根据颜料类型设置颜色
            if (code.includes('Y')) colors.push('#F4C430'); // 黄色
            else if (code.includes('B')) colors.push('#2A58D1'); // 蓝色
            else if (code.includes('R')) colors.push('#B91D23'); // 红色
            else if (code === '073') colors.push('#FF7F00'); // 橙色
            else if (code === 'W064') colors.push('#FFFFFF'); // 白色
            else if (code === 'V23') colors.push('#800080'); // 紫色
            else if (code === 'G7') colors.push('#229954'); // 绿色
            else if (code === 'BK7H') colors.push('#000000'); // 黑色
            else colors.push('#CCCCCC'); // 默认
          }
        }
      });
      
      paintChart.data.labels = labels;
      paintChart.data.datasets[0].data = data;
      paintChart.data.datasets[0].backgroundColor = colors;
      paintChart.update();
    }

    // 处理容量变化
    function handleVolumeChange(volume) {
      currentState.volume = volume;
      currentState.volumeFactor = VOLUME_FACTORS[volume];
      
      // 更新所有滑块的最大值
      Object.keys(PAINT_DATA).forEach(code => {
        const slider = elements[`slider${code}`];
        if (slider) {
          slider.max = Math.round(1000 * currentState.volumeFactor);
        }
      });
      
      // 重新计算颜料用量
      if (currentState.ral) {
        updatePaintWeights();
      } else {
        calculateTotals();
      }
    }

    // 计算总量和比例
    function calculateTotals() {
      const paintCodes = Object.keys(PAINT_DATA);
      let total = 0;
      
      paintCodes.forEach(code => {
        const slider = elements[`slider${code}`];
        if (slider) {
          total += parseInt(slider.value);
        }
      });
      
      // 更新总量显示
      elements.totalPigmentWeight.textContent = `${total}g`;
      
      // 更新清漆用量显示
      elements.varnishAmount.textContent = currentState.volume === '500ml' ? '500ML' : 
                                         currentState.volume === '1l' ? '1L' :
                                         currentState.volume === '5l' ? '5L' : '20L';
      
      // 计算每升用量
      const perLiter = Math.round(total / currentState.volumeFactor);
      elements.perLiterAmount.textContent = `${perLiter}g`;
      
      // 估算勺数 (1标准勺 ≈ 50g)
      const scoops = Math.round(total / 50);
      elements.scoopEstimate.textContent = scoops;
      
      // 计算混合比例
      const varnishWeight = currentState.volumeFactor * 1000; // 1L清漆 ≈ 1000g假设
      const totalWeight = total + varnishWeight;
      const pigmentRatio = Math.round((total / totalWeight) * 100);
      const varnishRatio = 100 - pigmentRatio;
      elements.mixingRatio.textContent = `${pigmentRatio} : ${varnishRatio}`;
    }

    // 初始化RAL选择下拉菜单
    function initRalSelect() {
      // 清除现有选项
      elements.ralSelect.innerHTML = `<option value="" data-i18n="select_ral_code">选择RAL代码</option>`;
      
      // 按RAL编号升序排序
      const sortedRal = [...ralPaintMap].sort((a, b) => parseInt(a.ral) - parseInt(b.ral));
      
      // 添加分组选项
      let currentGroup = '';
      sortedRal.forEach(item => {
        // 提取颜色系列组 (前1-2位)
        const group = item.ral.substring(0, 1);
        const groupNames = {
          '1': currentLanguage === 'zh' ? '黄色' : currentLanguage === 'en' ? 'Yellow' : 'イエロー',
          '2': currentLanguage === 'zh' ? '橙色' : currentLanguage === 'en' ? 'Orange' : 'オレンジ',
          '3': currentLanguage === 'zh' ? '红色' : currentLanguage === 'en' ? 'Red' : 'レッド',
          '4': currentLanguage === 'zh' ? '紫色' : currentLanguage === 'en' ? 'Purple' : 'パープル',
          '5': currentLanguage === 'zh' ? '蓝色' : currentLanguage === 'en' ? 'Blue' : 'ブルー',
          '6': currentLanguage === 'zh' ? '绿色' : currentLanguage === 'en' ? 'Green' : 'グリーン',
          '7': currentLanguage === 'zh' ? '灰色' : currentLanguage === 'en' ? 'Grey' : 'グレー',
          '8': currentLanguage === 'zh' ? '棕色' : currentLanguage === 'en' ? 'Brown' : 'ブラウン',
          '9': currentLanguage === 'zh' ? '中性' : currentLanguage === 'en' ? 'Neutral' : 'ニュートラル'
        };
        
        // 添加组标题
        if (currentGroup !== group) {
          currentGroup = group;
          const optgroup = document.createElement('optgroup');
          optgroup.label = groupNames[group] || `${currentLanguage === 'zh' ? '组' : currentLanguage === 'en' ? 'Group' : 'グループ'} ${group}`;
          elements.ralSelect.appendChild(optgroup);
        }
        
        // 添加颜色代码选项
        const option = document.createElement('option');
        option.value = item.ral;
        const nameKey = `name_${currentLanguage}`;
        const displayName = item[nameKey] || item.name_en;
        option.textContent = `${item.ral} - ${displayName}`;
        
        // 添加到最后一个组
        elements.ralSelect.lastElementChild.appendChild(option);
      });
    }

    // 更新RAL选择器（语言切换时调用）
    function updateRalSelect() {
      initRalSelect();
    }
    
    // 初始化快速RAL代码
    function initQuickRals() {
      elements.quickRalContainer.innerHTML = '';
      
      popularRals.forEach(ral => {
        const button = document.createElement('button');
        button.className = 'flex items-center gap-1.5 px-2 py-1.5 bg-white border border-gray-200 rounded-lg text-xs hover:border-primary hover:bg-primary/5 transition-custom';
        button.innerHTML = `
          <span class="w-3 h-3 rounded-full" style="background-color: ${ral.hex};"></span>
          <span>${ral.ral}</span>
          <span class="text-gray-500">${ral.name}</span>
        `;
        button.addEventListener('click', () => {
          const targetRal = ralPaintMap.find(item => item.ral === ral.ral);
          if (targetRal) {
            updateByRal(targetRal);
            elements.ralSelect.value = ral.ral;
          }
        });
        elements.quickRalContainer.appendChild(button);
      });
    }
    
    // 初始化最近使用的颜色代码
    function initRecentlyUsed() {
      if (currentState.recentlyUsed.length === 0) {
        elements.recentlyUsedContainer.classList.add('hidden');
        return;
      }
      
      elements.recentlyUsedContainer.classList.remove('hidden');
      elements.recentlyUsedRals.innerHTML = '';
      
      currentState.recentlyUsed.forEach(ralCode => {
        const ralData = ralPaintMap.find(item => item.ral === ralCode);
        if (!ralData) return;
        
        const button = document.createElement('button');
        button.className = 'flex items-center gap-1 px-2 py-1 bg-white border border-gray-200 rounded-lg text-xs hover:border-primary transition-custom';
        button.innerHTML = `
          <span class="w-3 h-3 rounded-full" style="background-color: ${ralData.hex};"></span>
          <span>${ralData.ral}</span>
        `;
        button.addEventListener('click', () => {
          updateByRal(ralData);
          elements.ralSelect.value = ralData.ral;
        });
        elements.recentlyUsedRals.appendChild(button);
      });
    }
    
    // 保存最近使用的颜色代码
    function saveRecentlyUsed(ralCode) {
      // 移除现有的相同颜色代码
      let recentlyUsed = currentState.recentlyUsed.filter(code => code !== ralCode);
      // 添加到开头
      recentlyUsed.unshift(ralCode);
      // 限制为最多5个
      if (recentlyUsed.length > 5) {
        recentlyUsed = recentlyUsed.slice(0, 5);
      }
      
      currentState.recentlyUsed = recentlyUsed;
      localStorage.setItem('moocow_recent_rals', JSON.stringify(recentlyUsed));
      initRecentlyUsed();
    }
    
    // 切换收藏状态
    function toggleFavorite(ralCode) {
      if (!ralCode) return;
      
      let favorites = currentState.favorites;
      const isFavorite = favorites.includes(ralCode);
      
      if (isFavorite) {
        // 移除收藏
        favorites = favorites.filter(code => code !== ralCode);
        elements.favoriteBtn.innerHTML = '<i class="fa fa-star-o text-xs"></i>';
        showNotification(TRANSLATIONS[currentLanguage]['已从收藏中移除'] || '已从收藏中移除');
      } else {
        // 添加收藏
        favorites.push(ralCode);
        elements.favoriteBtn.innerHTML = '<i class="fa fa-star text-xs text-secondary"></i>';
        showNotification(TRANSLATIONS[currentLanguage]['已添加到收藏'] || '已添加到收藏');
      }
      
      currentState.favorites = favorites;
      localStorage.setItem('moocow_favorite_rals', JSON.stringify(favorites));
    }
    
    // 获取保存的收藏
    function getSavedFavorites() {
      try {
        const saved = localStorage.getItem('moocow_favorite_rals');
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        return [];
      }
    }
    
    // 更新收藏按钮状态
    function updateFavoriteButton(ralCode) {
      if (!ralCode) {
        elements.favoriteBtn.innerHTML = '<i class="fa fa-star-o text-xs"></i>';
        return;
      }
      
      const isFavorite = currentState.favorites.includes(ralCode);
      elements.favoriteBtn.innerHTML = isFavorite 
        ? '<i class="fa fa-star text-xs text-secondary"></i>' 
        : '<i class="fa fa-star-o text-xs"></i>';
    }
    
    // 显示搜索建议
    function showSearchSuggestions(results) {
      if (results.length === 0) {
        const noResultText = currentLanguage === 'zh' ? '未找到匹配结果' : 
                            currentLanguage === 'en' ? 'No matching results found' : 
                            '一致する結果が見つかりません';
        elements.searchSuggestions.innerHTML = `<div class="px-3 py-2 text-gray-500 text-sm">${noResultText}</div>`;
        elements.searchSuggestions.classList.remove('hidden');
        return;
      }
      
      elements.searchSuggestions.innerHTML = '';
      results.slice(0, 8).forEach(item => {
        const div = document.createElement('div');
        div.className = 'px-3 py-2 hover:bg-primary/5 cursor-pointer flex items-center gap-2 text-sm';
        const nameKey = `name_${currentLanguage}`;
        const displayName = item[nameKey] || item.name_en;
        div.innerHTML = `
          <span class="w-3 h-3 rounded-full" style="background-color: ${item.hex};"></span>
          <span>${item.ral} - ${displayName}</span>
          <span class="text-gray-500 text-xs ml-auto">${item.name_en}</span>
        `;
        div.addEventListener('click', () => {
          updateByRal(item);
          elements.ralSelect.value = item.ral;
          elements.ralSearch.value = item.ral;
          elements.searchSuggestions.classList.add('hidden');
        });
        elements.searchSuggestions.appendChild(div);
      });
      
      elements.searchSuggestions.classList.remove('hidden');
    }

    // 根据容量和RAL颜色代码更新颜料重量
    function updatePaintWeights() {
      if (!currentState.ral) return;
      
      const { baseRecipe } = currentState.ral;
      const { volumeFactor } = currentState;
      
      // 重置所有滑块
      resetAllSliders();
      
      // 确保基础配方存在
      if (!baseRecipe) {
        console.error('未找到基础配方数据');
        return;
      }
      
      // 处理所有颜料
      Object.keys(baseRecipe).forEach(code => {
        updateSinglePaint(code, baseRecipe[code], volumeFactor);
      });
      
      calculateTotals();
      updatePaintChart();
    }
    
    // 更新单个颜料重量
    function updateSinglePaint(code, baseWeight, volumeFactor) {
      const scaledWeight = Math.round(baseWeight * volumeFactor);
      
      const slider = elements[`slider${code}`];
      const valueDisplay = elements[`value${code}`];
      
      // 确保元素存在
      if (!slider || !valueDisplay) {
        console.error(`未找到颜料元素: ${code}`);
        return;
      }
      
      // 设置滑块最大值（根据容量调整）
      slider.max = Math.round(1000 * volumeFactor);
      slider.value = scaledWeight;
      
      // 强制更新显示
      valueDisplay.textContent = `${scaledWeight}g`;
      
      // 视觉反馈
      valueDisplay.classList.add('scale-110');
      setTimeout(() => {
        valueDisplay.classList.remove('scale-110');
      }, 200);
      
      // 高亮推荐颜料
      highlightRecommendedPaint(code);
    }
    
    // 调整颜料重量（+/-）
    function adjustPaintWeight(code, action) {
      const slider = elements[`slider${code}`];
      const valueDisplay = elements[`value${code}`];
      
      if (!slider || !valueDisplay) return;
      
      let currentValue = parseInt(slider.value);
      const maxValue = parseInt(slider.max);
      
      if (action === 'increase') {
        currentValue = Math.min(currentValue + ADJUST_STEP, maxValue);
      } else {
        currentValue = Math.max(currentValue - ADJUST_STEP, 0);
      }
      
      slider.value = currentValue;
      valueDisplay.textContent = `${currentValue}g`;
      
      // 视觉反馈
      valueDisplay.classList.add('scale-110');
      setTimeout(() => {
        valueDisplay.classList.remove('scale-110');
      }, 200);
      
      calculateTotals();
      updatePaintChart();
      checkColorSuggestions();
    }

    // 重置所有滑块
    function resetAllSliders() {
      const paintCodes = Object.keys(PAINT_DATA);
      
      paintCodes.forEach(code => {
        const slider = elements[`slider${code}`];
        const valueDisplay = elements[`value${code}`];
        const label = slider?.parentElement?.querySelector('label');
        
        if (slider && valueDisplay) {
          slider.value = 0;
          valueDisplay.textContent = '0g';
        }
        
        if (label) {
          label.classList.remove('font-medium');
        }
        
        if (slider) {
          slider.classList.remove('ring-2', 'ring-primary/30');
        }
      });
    }

    // 高亮推荐颜料
    function highlightRecommendedPaint(code) {
      if (!currentState.ral) return;
      
      const { recommendedPaints } = currentState.ral;
      if (!recommendedPaints || !recommendedPaints.includes(code)) return;
      
      const slider = elements[`slider${code}`];
      const label = slider?.parentElement?.querySelector('label');
      
      if (label) {
        label.classList.add('font-medium');
      }
      
      if (slider) {
        slider.classList.add('ring-2', 'ring-primary/30');
      }
    }

    // 选择RAL后更新
    function updateByRal(ralData) {
      if (!ralData) return;
      currentState.ral = ralData;
      
      // 保存到最近使用
      saveRecentlyUsed(ralData.ral);
      
      // 更新颜色预览
      elements.colorSwatch.style.backgroundColor = ralData.hex;
      elements.canBody.style.backgroundColor = ralData.hex;
      
      const nameKey = `name_${currentLanguage}`;
      const displayName = ralData[nameKey] || ralData.name_en;
      elements.currentRalCode.textContent = `${ralData.ral} (${displayName})`;
      elements.currentHex.textContent = ralData.hex;
      elements.canLabel.textContent = `RAL ${ralData.ral}`;
      
      // 更新收藏按钮状态
      updateFavoriteButton(ralData.ral);
      
      // 视觉反馈
      elements.currentRalCode.classList.add('scale-105');
      elements.currentHex.classList.add('scale-105');
      setTimeout(() => {
        elements.currentRalCode.classList.remove('scale-105');
        elements.currentHex.classList.remove('scale-105');
      }, 200);
      
      // 更新颜料重量
      updatePaintWeights();
      
      // 隐藏颜色建议
      elements.colorSuggestion.classList.add('hidden');
    }

    // 检查配色建议
    function checkColorSuggestions() {
      // 简单的配色建议逻辑
      const paintCodes = Object.keys(PAINT_DATA);
      let totalWeight = 0;
      let redWeight = 0;
      let whiteWeight = 0;
      
      paintCodes.forEach(code => {
        const slider = elements[`slider${code}`];
        if (slider) {
          const weight = parseInt(slider.value);
          totalWeight += weight;
          
          if (code.includes('R')) redWeight += weight;
          if (code === 'W064') whiteWeight += weight;
        }
      });
      
      if (totalWeight > 0) {
        const redRatio = redWeight / totalWeight;
        const whiteRatio = whiteWeight / totalWeight;
        
        if (redRatio > 0.6 && whiteRatio < 0.2) {
          const suggestionText = TRANSLATIONS[currentLanguage]['suggestion_text'];
          elements.suggestionText.textContent = suggestionText;
          elements.colorSuggestion.classList.remove('hidden');
        } else {
          elements.colorSuggestion.classList.add('hidden');
        }
      }
    }

    // 导出配方
    function exportRecipe() {
      if (!currentState.ral) {
        const errorText = currentLanguage === 'zh' ? '请先选择RAL颜色代码' : 
                         currentLanguage === 'en' ? 'Please select a RAL color code first' : 
                         'まずRAL色コードを選択してください';
        showNotification(errorText, 'error');
        return;
      }
      
      const paintCodes = Object.keys(PAINT_DATA);
      const nameKey = `name_${currentLanguage}`;
      const displayName = currentState.ral[nameKey] || currentState.ral.name_en;
      
      let recipeText = `MooCow Mini ${TRANSLATIONS[currentLanguage]['subtitle']}\n`;
      recipeText += `RAL${TRANSLATIONS[currentLanguage]['current_ral'].replace(':', '')}: ${currentState.ral.ral} - ${displayName}\n`;
      recipeText += `${TRANSLATIONS[currentLanguage]['color_value'].replace(':', '')}: ${currentState.ral.hex}\n`;
      recipeText += `${TRANSLATIONS[currentLanguage]['volume_selection'].replace(':', '')}: ${currentState.volume.toUpperCase()}\n\n`;
      
      const formulaLabel = currentLanguage === 'zh' ? '颜料配方' : 
                          currentLanguage === 'en' ? 'Paint Formula' : 
                          '塗料配合';
      recipeText += `${formulaLabel}:\n`;
      
      let totalWeight = 0;
      paintCodes.forEach(code => {
        const slider = elements[`slider${code}`];
        const paintInfo = PAINT_DATA[code];
        
        if (slider && paintInfo) {
          const weight = parseInt(slider.value);
          if (weight > 0) {
            const paintName = paintInfo[nameKey] || paintInfo.name;
            recipeText += `${paintName} (${code}): ${weight}g\n`;
            totalWeight += weight;
          }
        }
      });
      
      const totalLabel = TRANSLATIONS[currentLanguage]['total_pigment_weight'].replace(':', '');
      const perLiterLabel = TRANSLATIONS[currentLanguage]['per_liter_usage'].replace(':', '');
      const timeLabel = currentLanguage === 'zh' ? '生成时间' : 
                       currentLanguage === 'en' ? 'Generated at' : 
                       '生成時刻';
      
      recipeText += `\n${totalLabel}: ${totalWeight}g\n`;
      recipeText += `${perLiterLabel}: ${Math.round(totalWeight / currentState.volumeFactor)}g\n`;
      recipeText += `\n${timeLabel}: ${new Date().toLocaleString()}\n`;
      
      // 创建文件并下载
      const blob = new Blob([recipeText], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `MooCow_${TRANSLATIONS[currentLanguage]['subtitle']}_RAL${currentState.ral.ral}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      const successText = currentLanguage === 'zh' ? '配方已导出' : 
                         currentLanguage === 'en' ? 'Recipe exported' : 
                         '配合をエクスポートしました';
      showNotification(successText);
    }

    // 复制配方到剪贴板
    function copyRecipeToClipboard() {
      if (!currentState.ral) {
        const errorText = currentLanguage === 'zh' ? '请先选择RAL颜色代码' : 
                         currentLanguage === 'en' ? 'Please select a RAL color code first' : 
                         'まずRAL色コードを選択してください';
        showNotification(errorText, 'error');
        return;
      }
      
      const paintCodes = Object.keys(PAINT_DATA);
      const nameKey = `name_${currentLanguage}`;
      
      const formulaLabel = currentLanguage === 'zh' ? '配方' : 
                          currentLanguage === 'en' ? 'Formula' : 
                          '配合';
      let recipeText = `RAL${currentState.ral.ral} ${formulaLabel}: `;
      
      const usedPaints = [];
      paintCodes.forEach(code => {
        const slider = elements[`slider${code}`];
        const paintInfo = PAINT_DATA[code];
        
        if (slider && paintInfo) {
          const weight = parseInt(slider.value);
          if (weight > 0) {
            const paintName = paintInfo[nameKey] || paintInfo.name;
            usedPaints.push(`${paintName}${weight}g`);
          }
        }
      });
      
      recipeText += usedPaints.join(', ');
      recipeText += ` (${currentState.volume.toUpperCase()}${TRANSLATIONS[currentLanguage]['varnish_usage'].replace(':', '').replace('清漆用量', '清漆').replace('Varnish Usage', 'Varnish').replace('クリア基材使用量', 'クリア')})`;

      
      navigator.clipboard.writeText(recipeText).then(() => {
        const successText = currentLanguage === 'zh' ? '配方已复制到剪贴板' : 
                           currentLanguage === 'en' ? 'Recipe copied to clipboard' : 
                           '配合をクリップボードにコピーしました';
        showNotification(successText);
      }).catch(() => {
        const errorText = currentLanguage === 'zh' ? '复制失败' : 
                         currentLanguage === 'en' ? 'Copy failed' : 
                         'コピーに失敗しました';
        showNotification(errorText, 'error');
      });
    }

    // 分享配方
    function shareRecipe() {
      if (!currentState.ral) {
        const errorText = currentLanguage === 'zh' ? '请先选择RAL颜色代码' : 
                         currentLanguage === 'en' ? 'Please select a RAL color code first' : 
                         'まずRAL色コードを選択してください';
        showNotification(errorText, 'error');
        return;
      }
      
      const paintCodes = Object.keys(PAINT_DATA);
      const nameKey = `name_${currentLanguage}`;
      
      const shareIntro = currentLanguage === 'zh' ? `使用MooCow Mini调色工具调出了RAL${currentState.ral.ral}颜色代码。配方如下:\n` : 
                        currentLanguage === 'en' ? `Mixed RAL${currentState.ral.ral} color code using MooCow Mini Color Mixing Tool. Formula:\n` : 
                        `MooCow Mini調色ツールでRAL${currentState.ral.ral}色コードを調色しました。配合は以下の通りです:\n`;
      let shareText = shareIntro;
      
      paintCodes.forEach(code => {
        const slider = elements[`slider${code}`];
        const paintInfo = PAINT_DATA[code];
        
        if (slider && paintInfo) {
          const weight = parseInt(slider.value);
          if (weight > 0) {
            const paintName = paintInfo[nameKey] || paintInfo.name;
            shareText += `${paintName}: ${weight}g\n`;
          }
        }
      });
      
      if (navigator.share) {
        navigator.share({
          title: `RAL${currentState.ral.ral} ${TRANSLATIONS[currentLanguage]['subtitle']}`,
          text: shareText
        });
      } else {
        copyRecipeToClipboard();
      }
    }

    // 显示通知
    function showNotification(message, type = 'success') {
      const notification = elements.notification;
      const notificationText = elements.notificationText;
      
      notificationText.textContent = message;
      
      // 设置图标
      const icon = notification.querySelector('i');
      if (type === 'error') {
        icon.className = 'fa fa-exclamation-circle text-red-400';
        notification.style.backgroundColor = '#dc2626';
      } else {
        icon.className = 'fa fa-check-circle text-green-400';
        notification.style.backgroundColor = '#333333';
      }
      
      // 显示通知
      notification.classList.remove('translate-y-20', 'opacity-0');
      notification.classList.add('translate-y-0', 'opacity-100');
      
      // 3秒后隐藏
      setTimeout(() => {
        notification.classList.remove('translate-y-0', 'opacity-100');
        notification.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }
    
    // 重置配方
    function resetFormula() {
      if (!currentState.ral) {
        resetAllSliders();
        calculateTotals();
        updatePaintChart();
        return;
      }
      
      // 重置确认
      const confirmText = currentLanguage === 'zh' ? '确定要重置当前配方吗？将恢复为默认比例。' : 
                         currentLanguage === 'en' ? 'Are you sure you want to reset the current formula? It will be restored to default ratios.' : 
                         '現在の配合をリセットしてもよろしいですか？デフォルトの比率に戻ります。';
      if (confirm(confirmText)) {
        updatePaintWeights();
        elements.addFormulaBtn.classList.remove('used');
        const addText = TRANSLATIONS[currentLanguage]['add_formula'];
        elements.addFormulaBtn.innerHTML = `<i class="fa fa-plus-circle"></i><span>${addText}</span>`;
        
        const successText = currentLanguage === 'zh' ? '配方已重置为默认值' : 
                           currentLanguage === 'en' ? 'Formula reset to default values' : 
                           '配合をデフォルト値にリセットしました';
        showNotification(successText);
      }
    }
    
    // 初始化指导
    function initGuide() {
      // 检查是否首次使用
      const hasVisited = localStorage.getItem('moocow_visited');
      if (!hasVisited) {
        showGuide();
        localStorage.setItem('moocow_visited', 'true');
      }
    }
    
    // 显示指导
    function showGuide() {
      elements.guideOverlay.classList.remove('hidden');
      elements.guideOverlay.classList.add('flex');
    }
    
    // 隐藏指导
    function hideGuide() {
      elements.guideOverlay.classList.remove('flex');
      elements.guideOverlay.classList.add('hidden');
    }
    
    // 导航指导步骤
    function navigateGuide(step) {
      const steps = elements.guideSteps.querySelectorAll('.guide-step');
      
      // 隐藏所有步骤
      steps.forEach(s => s.classList.add('hidden'));
      
      // 显示当前步骤
      steps[step].classList.remove('hidden');
      steps[step].classList.add('active', 'slide-up');
      
      // 更新按钮状态
      elements.prevGuideBtn.classList.toggle('hidden', step === 0);
      elements.nextGuideBtn.classList.toggle('hidden', step === steps.length - 1);
      elements.finishGuideBtn.classList.toggle('hidden', step !== steps.length - 1);
    }

    // 获取最近使用的颜色代码
    function getRecentlyUsedRals() {
      try {
        const saved = localStorage.getItem('moocow_recent_rals');
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        return [];
      }
    }

    // 绑定所有交互事件
    function bindEvents() {
      // 语言切换
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          switchLanguage(btn.dataset.lang);
        });
      });

      // RAL搜索
      elements.ralSearch.addEventListener('input', debounce(function() {
        const searchTerm = this.value.trim().toLowerCase();
        if (!searchTerm) {
          elements.searchSuggestions.classList.add('hidden');
          return;
        }
        
        const matched = ralPaintMap.filter(item => {
          const nameKey = `name_${currentLanguage}`;
          const displayName = item[nameKey] || item.name_en;
          return item.ral.includes(searchTerm) || 
                 displayName.toLowerCase().includes(searchTerm) || 
                 item.name_en.toLowerCase().includes(searchTerm);
        });
        
        showSearchSuggestions(matched);
      }, 200));
      
      // 点击其他地方关闭搜索建议
      document.addEventListener('click', (e) => {
        if (!elements.ralSearch.contains(e.target) && !elements.searchSuggestions.contains(e.target)) {
          elements.searchSuggestions.classList.add('hidden');
        }
      });

      // RAL颜色代码选择
      elements.ralSelect.addEventListener('change', function() {
        const selectedRal = this.value;
        if (!selectedRal) return;
        
        const targetRal = ralPaintMap.find(item => item.ral === selectedRal);
        if (targetRal) {
          updateByRal(targetRal);
        } else {
          console.error(`未找到RAL颜色代码: ${selectedRal}`);
        }
      });
      
      // 收藏按钮
      elements.favoriteBtn.addEventListener('click', () => {
        if (currentState.ral) {
          toggleFavorite(currentState.ral.ral);
        }
      });

      // 容量选择
      elements.volumeSelect.addEventListener('change', function() {
        handleVolumeChange(this.value);
      });

      // 颜料滑块拖拽
      const paintCodes = Object.keys(PAINT_DATA);
      paintCodes.forEach(code => {
        const slider = elements[`slider${code}`];
        const valueDisplay = elements[`value${code}`];
        
        if (slider && valueDisplay) {
          slider.addEventListener('input', function() {
            valueDisplay.textContent = `${this.value}g`;
            // 视觉反馈
            valueDisplay.classList.add('scale-110');
            setTimeout(() => {
              valueDisplay.classList.remove('scale-110');
            }, 200);
            
            calculateTotals();
            updatePaintChart();
            checkColorSuggestions();
          });
        }
      });
      
      // 颜料微调按钮
      document.querySelectorAll('.paint-adjust-btn').forEach(button => {
        button.addEventListener('click', function() {
          const code = this.dataset.paint;
          const action = this.dataset.action;
          adjustPaintWeight(code, action);
        });
      });

      // 添加配方
      elements.addFormulaBtn.addEventListener('click', function() {
        if (!currentState.ral) {
          const errorText = currentLanguage === 'zh' ? '请先选择RAL颜色代码' : 
                           currentLanguage === 'en' ? 'Please select a RAL color code first' : 
                           'まずRAL色コードを選択してください';
          showNotification(errorText, 'error');
          return;
        }
        
        const { recommendedPaints } = currentState.ral;
        if (!recommendedPaints || recommendedPaints.length === 0) return;
        
        // 调整各颜料用量（+5%）
        recommendedPaints.forEach(code => {
          const slider = elements[`slider${code}`];
          const valueDisplay = elements[`value${code}`];
          
          if (slider && valueDisplay) {
            const currentWeight = parseInt(slider.value);
            const newWeight = Math.round(currentWeight * 1.05);
            
            slider.value = newWeight;
            valueDisplay.textContent = `${newWeight}g`;
          }
        });
        
        calculateTotals();
        updatePaintChart();
        this.classList.add('used');
        
        const successIcon = '<i class="fa fa-check-circle"></i>';
        const successText = currentLanguage === 'zh' ? '✓ 已添加配方微调' : 
                           currentLanguage === 'en' ? '✓ Formula adjustment added' : 
                           '✓ メリフ配合を追加しました';
        this.innerHTML = `${successIcon}<span>${successText}</span>`;
        
        const notificationText = currentLanguage === 'zh' ? '已应用配方微调' : 
                                currentLanguage === 'en' ? 'Formula adjustment applied' : 
                                'メリフ配合の微調整を適用しました';
        showNotification(notificationText);
      });
      
      // 重置配方
      elements.resetFormulaBtn.addEventListener('click', resetFormula);

      // 导出配方
      elements.exportRecipeBtn.addEventListener('click', exportRecipe);
      
      // 复制配方
      elements.copyRecipeBtn.addEventListener('click', copyRecipeToClipboard);
      
      // 分享配方
      elements.shareRecipeBtn.addEventListener('click', shareRecipe);
      
      // 帮助按钮
      elements.helpBtn1.addEventListener('click', () => { navigateGuide(0); showGuide(); });
      elements.helpBtn2.addEventListener('click', () => { navigateGuide(1); showGuide(); });
      elements.helpBtn3.addEventListener('click', () => { navigateGuide(2); showGuide(); });
      
      // 指导事件
      elements.closeGuideBtn.addEventListener('click', hideGuide);
      
      let currentGuideStep = 0;
      elements.nextGuideBtn.addEventListener('click', () => {
        const steps = elements.guideSteps.querySelectorAll('.guide-step');
        if (currentGuideStep < steps.length - 1) {
          currentGuideStep++;
          navigateGuide(currentGuideStep);
        }
      });
      
      elements.prevGuideBtn.addEventListener('click', () => {
        if (currentGuideStep > 0) {
          currentGuideStep--;
          navigateGuide(currentGuideStep);
        }
      });
      
      elements.finishGuideBtn.addEventListener('click', hideGuide);
      
      // 推荐配方点击
      elements.recipePresets.forEach(preset => {
        preset.addEventListener('click', function() {
          const ralCode = this.dataset.ral;
          const targetRal = ralPaintMap.find(item => item.ral === ralCode);
          if (targetRal) {
            updateByRal(targetRal);
            elements.ralSelect.value = ralCode;
          }
        });
      });
      
      // 帮助提示的显示/隐藏
      document.querySelectorAll('[id^="helpBtn"]').forEach(btn => {
        const tooltip = btn.querySelector('.guide-tooltip');
        
        btn.addEventListener('mouseenter', () => {
          tooltip.style.opacity = '1';
        });
        
        btn.addEventListener('mouseleave', () => {
          tooltip.style.opacity = '0';
        });
      });
    }

    // 防抖函数
    function debounce(func, delay = 300) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // 首字母大写
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    // 工具初始化
    function init() {
      // 加载保存的语言偏好
      const savedLanguage = localStorage.getItem('moocow_language') || 'zh';
      switchLanguage(savedLanguage);
      
      // 初始化颜色代码选择器
      initRalSelect();
      
      // 初始化快速颜色代码
      initQuickRals();
      
      // 初始化最近使用
      initRecentlyUsed();
      
      // 绑定事件
      bindEvents();
      
      // 默认1L容量
      handleVolumeChange('1l');
      
      // 初始化图表
      initPaintChart();
      
      // 初始化指导
      initGuide();
      
      // 初始计算
      calculateTotals();
    }

    // 启动工具
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
