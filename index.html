<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MooCow Mini 调色工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2A58D1', secondary: '#F4C430', accent: '#B91D23',
            neutral: '#F5F7FA', dark: '#333333',
          },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .slider-thumb { @apply appearance-none w-5 h-5 rounded-full cursor-pointer transition-all duration-200 hover:scale-125; }
      .paint-dot { @apply w-4 h-4 rounded-full border border-gray-300 mr-2 flex-shrink-0; }
      .lang-btn { @apply px-3 py-1.5 text-sm font-medium rounded-lg transition-all duration-200 border border-gray-200; }
    }
    input[type="range"] { @apply appearance-none w-full h-2 rounded-full bg-gray-200 outline-none; }
    #sliderY83S::-webkit-slider-thumb { @apply slider-thumb bg-[#F4C430]; }
    #sliderY74S::-webkit-slider-thumb { @apply slider-thumb bg-[#F4C430]; }
    #sliderB150S::-webkit-slider-thumb { @apply slider-thumb bg-[#2A58D1]; }
    #sliderB153S::-webkit-slider-thumb { @apply slider-thumb bg-[#2A58D1]; }
    #sliderR254D::-webkit-slider-thumb { @apply slider-thumb bg-[#B91D23]; }
    #sliderR101Y::-webkit-slider-thumb { @apply slider-thumb bg-[#B91D23]; }
    #sliderR101V::-webkit-slider-thumb { @apply slider-thumb bg-[#B91D23]; }
    #sliderY42S::-webkit-slider-thumb { @apply slider-thumb bg-[#F4C430]; }
    #slider073::-webkit-slider-thumb { @apply slider-thumb bg-[#FF7F00]; }
    #sliderW064::-webkit-slider-thumb { @apply slider-thumb bg-white border border-gray-300; }
    #sliderV23::-webkit-slider-thumb { @apply slider-thumb bg-[#800080]; }
    #sliderG7::-webkit-slider-thumb { @apply slider-thumb bg-[#229954]; }
    #sliderR122S::-webkit-slider-thumb { @apply slider-thumb bg-[#B91D23]; }
    #sliderBK7H::-webkit-slider-thumb { @apply slider-thumb bg-[#000000]; }
    .lang-btn.active { @apply bg-primary text-white border-primary; }
    .lang-btn:not(.active) { @apply bg-white text-gray-600 hover:bg-gray-50; }
  </style>
</head>

<body class="bg-neutral font-sans text-dark min-h-screen py-4 md:py-8 px-4 md:px-6">
  <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="bg-primary text-white p-6 md:p-8 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
      <div class="relative z-10 flex items-center justify-between flex-wrap gap-2">
        <div class="flex items-center gap-3"><h1 class="text-2xl md:text-3xl font-bold">MooCow Mini</h1></div>
        <div class="flex items-center gap-3">
          <span class="text-white/80 text-sm md:text-base" data-i18n="subtitle"></span>
          <div class="flex gap-1 bg-white/10 rounded-lg p-1">
            <button class="lang-btn" data-lang="zh" title="中文">中</button>
            <button class="lang-btn" data-lang="en" title="English">EN</button>
            <button class="lang-btn" data-lang="ja" title="日本語">日</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="p-6 md:p-8 space-y-8">
      <div id="disclaimer" class="p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 text-yellow-500 pt-0.5"><i class="fa fa-info-circle"></i></div>
          <div>
            <h3 class="text-sm font-bold text-yellow-800" data-i18n="disclaimer_title"></h3>
            <p class="text-xs text-yellow-700 mt-1" data-i18n="disclaimer_text"></p>
          </div>
        </div>
      </div>
      
      <section class="space-y-4">
        <div class="flex items-center gap-2 text-primary font-bold"><span class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-sm">1</span><h2 class="text-lg" data-i18n="target_color_selection"></h2></div>
        <div class="bg-neutral rounded-xl p-4 md:p-5 space-y-4">
          <div class="flex flex-col md:flex-row gap-5">
            <div class="w-full md:w-24 h-24 md:h-auto rounded-lg border-2 border-gray-200 overflow-hidden shadow-sm"><div id="colorSwatch" class="w-full h-full transition-colors duration-300"></div></div>
            <div class="flex-1 space-y-3">
              <div>
                <label for="ralSearch" class="block text-sm text-gray-600 mb-1" data-i18n="ral_search_label"></label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fa fa-search"></i></span>
                  <input type="text" id="ralSearch" data-i18n-placeholder="ral_search_placeholder" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 outline-none">
                  <div id="searchSuggestions" class="absolute w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto hidden"></div>
                </div>
              </div>
              <div>
                <label for="ralSelect" class="block text-sm text-gray-600 mb-1" data-i18n="ral_select_label"></label>
                <select id="ralSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg appearance-none bg-white focus:ring-2 focus:ring-primary/50 outline-none"></select>
              </div>
              <div class="text-sm text-gray-600 flex flex-wrap gap-x-4 gap-y-1 pt-1">
                <span data-i18n="current_ral">当前RAL:<span id="currentRalCode" class="font-medium text-primary"></span></span>
                <span data-i18n="color_value">颜色值:<span id="currentHex" class="font-medium text-primary"></span></span>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <section class="space-y-4">
        <div class="flex items-center gap-2 text-primary font-bold"><span class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-sm">2</span><h2 class="text-lg" data-i18n="paint_weight_adjustment"></h2></div>
        <div class="bg-neutral rounded-xl p-4 md:p-5 space-y-5">
          <div class="flex flex-wrap items-center gap-x-6 gap-y-3">
            <div class="flex items-center gap-3">
              <label for="volumeSelect" class="text-sm text-gray-600" data-i18n="volume_selection"></label>
              <select id="volumeSelect" class="max-w-[150px] px-3 py-2 border border-gray-300 rounded-lg appearance-none bg-white focus:ring-2 focus:ring-primary/50 outline-none">
                <option value="500ml">500ML</option><option value="1l" selected>1L</option><option value="5l">5L</option><option value="20l">20L</option>
              </select>
            </div>
            <p class="text-xs text-gray-500" data-i18n="volume_hint"></p>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4" id="paintSlidersContainer"></div>
          <div class="bg-white p-4 rounded-lg border border-gray-100">
            <h3 class="text-sm font-medium mb-3" data-i18n="paint_ratio"></h3>
            <div class="flex flex-col lg:flex-row gap-4 items-center">
              <div class="w-full lg:w-1/2 h-[180px]"><canvas id="paintChart"></canvas></div>
              <div class="w-full lg:w-1/2 space-y-2 text-sm">
                <div><span data-i18n="total_pigment_weight"></span><strong id="totalPigmentWeight" class="text-primary text-base">0.0g</strong><span id="scoopEstimate" class="text-xs text-gray-500 ml-2"></span></div>
                <div><span data-i18n="varnish_usage"></span><strong id="varnishAmount" class="text-gray-700">1L</strong></div>
                <div><span data-i18n="per_liter_usage"></span><strong id="perLiterAmount" class="text-gray-700">0.0g</strong></div>
                <div class="text-accent font-semibold"><span data-i18n="mixing_ratio"></span><strong id="mixingRatio">0 : 100</strong></div>
                <div class="flex flex-wrap gap-2 pt-2">
                  <button id="resetFormulaBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300"><i class="fa fa-refresh mr-1"></i><span data-i18n="reset_formula"></span></button>
                  <button id="addFormulaBtn" class="px-4 py-2 bg-secondary text-dark rounded-lg text-sm font-medium hover:bg-secondary/90 transition-transform hover:scale-105"><i class="fa fa-plus-circle mr-1"></i><span data-i18n="add_formula"></span></button>
                  <button id="generateRecipeBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-transform hover:scale-105"><i class="fa fa-magic mr-1"></i><span data-i18n="generate_recipe"></span></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="space-y-4">
        <div class="flex items-center gap-2 text-primary font-bold"><span class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-sm">3</span><h2 class="text-lg" data-i18n="package_preview_export"></h2></div>
         <div class="bg-neutral rounded-xl p-4 md:p-5 space-y-5">
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-1/3 space-y-3">
                    <button id="exportRecipeBtn" class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition flex items-center justify-center gap-2"><i class="fa fa-download"></i><span data-i18n="export_recipe"></span></button>
                    <div class="flex gap-2">
                        <button id="copyRecipeBtn" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition flex items-center justify-center gap-1 text-sm"><i class="fa fa-copy"></i><span data-i18n="copy_recipe"></span></button>
                        <button id="shareRecipeBtn" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition flex items-center justify-center gap-1 text-sm"><i class="fa fa-share-alt"></i><span data-i18n="share_recipe"></span></button>
                    </div>
                     <div class="bg-white p-3 rounded-lg border border-gray-100">
                        <h3 class="text-sm font-medium mb-2" data-i18n="recipe_includes_title"></h3>
                        <ul class="text-xs text-gray-600 space-y-1" data-i18n="recipe_includes_list"></ul>
                    </div>
                </div>
                <div class="w-full md:w-2/3 flex justify-center items-center pt-8">
                    <div class="relative" style="width: 120px; height: 160px;">
                        <div class="absolute bottom-0 left-0 w-full h-[140px] bg-gray-200 rounded-t-lg border-2 border-gray-400/50 shadow-inner" style="background-image: linear-gradient(to right, rgba(255,255,255,0.2), rgba(0,0,0,0.2));"><div id="canBody" class="absolute inset-0 transition-colors duration-500"></div></div>
                        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[90%] h-6 bg-gray-600 rounded-t-md border-t-2 border-l-2 border-r-2 border-gray-700" style="background-image: linear-gradient(to right, #888, #555);"></div>
                        <div class="absolute top-[calc(50%-20px)] left-1/2 -translate-x-1/2 bg-white px-3 py-1.5 rounded shadow-md text-center">
                            <span id="canLabel" class="font-bold text-gray-800 text-sm"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </section>

      <section class="space-y-2">
        <h3 class="text-base font-bold text-gray-700" data-i18n="recommended_recipes"></h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="recipePresetsContainer"></div>
      </section>
    </div>
  </div>
  
  <div id="notification" class="fixed bottom-4 right-4 bg-dark text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-24 opacity-0 transition-all z-50 text-sm"></div>
  
  <script>
    const TRANSLATIONS={zh:{subtitle:"调色工具",disclaimer_title:"友情提示",disclaimer_text:"本工具提供的所有配方与颜色仅供参考，不能作为实际生产标准。实际颜色会因颜料批次、基料、喷涂工艺等因素产生差异。",target_color_selection:"目标颜色选择",ral_search_label:"RAL代码搜索",ral_search_placeholder:"输入代码或颜色名",ral_select_label:"RAL代码选择",select_ral_code:"选择RAL代码",current_ral:"当前RAL:",color_value:"颜色值:",paint_weight_adjustment:"颜料重量调节",volume_selection:"基料容量:",volume_hint:"(切换容量将自动重算配方克重)",paint_ratio:"混合详情",total_pigment_weight:"总颜料重量: ",varnish_usage:"基料用量: ",per_liter_usage:"每升用量: ",mixing_ratio:"混合比例: 颜料 : 基料 = ",add_formula:"微调配方 (+5%)",reset_formula:"清空颜料",recommended_recipes:"推荐配方库 (点击加载配方)",package_preview_export:"包装预览与配方导出",export_recipe:"导出配方",copy_recipe:"复制配方",share_recipe:"分享",recipe_includes_title:"配方包含:",recipe_includes_list:`<li class="flex items-center gap-1.5"><i class="fa fa-check text-green-500"></i>RAL代码和颜色</li><li class="flex items-center gap-1.5"><i class="fa fa-check text-green-500"></i>各颜料精确重量</li><li class="flex items-center gap-1.5"><i class="fa fa-check text-green-500"></i>基料用量与比例</li>`,generate_recipe:"生成参考配方"},en:{subtitle:"Color Tool",disclaimer_title:"Disclaimer",disclaimer_text:"All formulas and colors are for reference only, not for production. Actual color may vary due to pigment batches, base materials, etc.",target_color_selection:"Target Color",ral_search_label:"RAL Code Search",ral_search_placeholder:"Enter code or name",ral_select_label:"RAL Code Selection",select_ral_code:"Select RAL Code",current_ral:"Current RAL:",color_value:"Color Value:",paint_weight_adjustment:"Pigment Adjustment",volume_selection:"Base Volume:",volume_hint:"(Changing volume recalculates weights)",paint_ratio:"Mix Details",total_pigment_weight:"Total Pigment: ",varnish_usage:"Base Amount: ",per_liter_usage:"Per Liter: ",mixing_ratio:"Ratio: P:B = ",add_formula:"Fine-tune (+5%)",reset_formula:"Clear Pigments",recommended_recipes:"Recommended Recipes (Click to load)",package_preview_export:"Preview & Export",export_recipe:"Export Recipe",copy_recipe:"Copy Recipe",share_recipe:"Share",recipe_includes_title:"Recipe includes:",recipe_includes_list:`<li class="flex items-center gap-1.5"><i class="fa fa-check text-green-500"></i>RAL Code & Color</li><li class="flex items-center gap-1.5"><i class="fa fa-check text-green-500"></i>Precise Pigment Weights</li><li class="flex items-center gap-1.5"><i class="fa fa-check text-green-500"></i>Base Amount & Ratio</li>`,generate_recipe:"Generate Recipe"},ja:{subtitle:"調色ツール",disclaimer_title:"免責事項",disclaimer_text:"提供される配合と色は参考用です。実際の色は顔料、基材、工程により異なります。",target_color_selection:"ターゲット色",ral_search_label:"RALコード検索",ral_search_placeholder:"コードまたは色名",ral_select_label:"RALコード選択",select_ral_code:"RALコードを選択",current_ral:"現在のRAL:",color_value:"色値:",paint_weight_adjustment:"顔料調整",volume_selection:"ベース容量:",volume_hint:"(容量変更で重量を再計算)",paint_ratio:"混合詳細",total_pigment_weight:"総顔料: ",varnish_usage:"ベース材: ",per_liter_usage:"リットル当たり: ",mixing_ratio:"混合比: P:B = ",add_formula:"微調整 (+5%)",reset_formula:"クリア",recommended_recipes:"推奨配合 (クリック読込)",package_preview_export:"プレビューとエクスポート",export_recipe:"配合をエクスポート",copy_recipe:"配合をコピー",share_recipe:"共有",recipe_includes_title:"レシピ内容:",recipe_includes_list:`<li class="flex items-center gap-1.5"><i class="fa fa-check text-green-500"></i>RALコードと色</li><li class="flex items-center gap-1.5"><i class="fa fa-check text-green-500"></i>正確な顔料重量</li><li class="flex items-center gap-1.5"><i class="fa fa-check text-green-500"></i>ベース量と比率</li>`,generate_recipe:"配合を生成"}};
    const PAINT_DATA={Y74S:{name_zh:"中黄",name_en:"Medium Yellow",hex:"#fedd00"},Y83S:{name_zh:"金黄",name_en:"Golden Yellow",hex:"#ffc700"},"073":{name_zh:"橙",name_en:"Orange",hex:"#ff7f00"},R254D:{name_zh:"大红",name_en:"Bright Red",hex:"#d8001d"},R101Y:{name_zh:"铁红(黄相)",name_en:"Iron Red (Y)",hex:"#c0392b"},R101V:{name_zh:"铁红(紫相)",name_en:"Iron Red (V)",hex:"#a93226"},R122S:{name_zh:"玫红",name_en:"Rose Red",hex:"#e4007f"},V23:{name_zh:"紫色",name_en:"Purple",hex:"#8e44ad"},B150S:{name_zh:"宝蓝",name_en:"Royal Blue",hex:"#0057b7"},B153S:{name_zh:"艳蓝",name_en:"Bright Blue",hex:"#009fe3"},G7:{name_zh:"绿色",name_en:"Green",hex:"#009a44"},Y42S:{name_zh:"铁黄",name_en:"Iron Yellow",hex:"#e8a317"},BK7H:{name_zh:"黑色",name_en:"Black",hex:"#1c1c1c"},W064:{name_zh:"白色",name_en:"White",hex:"#ffffff"}};
    const ralPaintMap=[{ral:"RAL 1000",name_en:"Green Beige",name_zh:"绿色米色",hex:"#BEBD7F"},{ral:"RAL 1001",name_en:"Beige",name_zh:"米色",hex:"#C2B078"},{ral:"RAL 1002",name_en:"Sand Yellow",name_zh:"沙黄色",hex:"#C6A664"},{ral:"RAL 1003",name_en:"Signal Yellow",name_zh:"信号黄",hex:"#E5BE01"},{ral:"RAL 1004",name_en:"Golden Yellow",name_zh:"金黄",hex:"#CDA434"},{ral:"RAL 1005",name_en:"Honey Yellow",name_zh:"蜂蜜黄",hex:"#A98307"},{ral:"RAL 1006",name_en:"Maize Yellow",name_zh:"玉米黄",hex:"#E4A010"},{ral:"RAL 1007",name_en:"Daffodil Yellow",name_zh:"水仙黄",hex:"#DC9D00"},{ral:"RAL 1011",name_en:"Brown Beige",name_zh:"棕米色",hex:"#8A6642"},{ral:"RAL 1012",name_en:"Lemon Yellow",name_zh:"柠檬黄",hex:"#C7B446"},{ral:"RAL 1013",name_en:"Oyster White",name_zh:"牡蛎白",hex:"#EAE6CA"},{ral:"RAL 1014",name_en:"Ivory",name_zh:"象牙色",hex:"#E1CC4F"},{ral:"RAL 1015",name_en:"Light Ivory",name_zh:"浅象牙",hex:"#E6D690"},{ral:"RAL 1016",name_en:"Sulfur Yellow",name_zh:"硫黄黄",hex:"#EDFF21"},{ral:"RAL 1017",name_en:"Saffron Yellow",name_zh:"藏红花黄",hex:"#F5D033"},{ral:"RAL 1018",name_en:"Zinc Yellow",name_zh:"锌黄",hex:"#F8F32B"},{ral:"RAL 1019",name_en:"Grey Beige",name_zh:"灰米色",hex:"#9E9764"},{ral:"RAL 1020",name_en:"Olive Yellow",name_zh:"橄榄黄",hex:"#999950"},{ral:"RAL 1021",name_en:"Rape Yellow",name_zh:"油菜黄",hex:"#F3DA0B"},{ral:"RAL 1023",name_en:"Traffic Yellow",name_zh:"交通黄",hex:"#FAD201"},{ral:"RAL 1024",name_en:"Ochre Yellow",name_zh:"赭黄",hex:"#AEA04B"},{ral:"RAL 2000",name_en:"Yellow Orange",name_zh:"黄橙色",hex:"#ED760E"},{ral:"RAL 2001",name_en:"Red Orange",name_zh:"红橙色",hex:"#C93C20"},{ral:"RAL 2002",name_en:"Vermilion",name_zh:"朱红",hex:"#CB2821"},{ral:"RAL 2003",name_en:"Pastel Orange",name_zh:"粉橙",hex:"#FF7514"},{ral:"RAL 2004",name_en:"Pure Orange",name_zh:"纯橙色",hex:"#F44611"},{ral:"RAL 3000",name_en:"Flame Red",name_zh:"火焰红",hex:"#AF2B1E"},{ral:"RAL 3001",name_en:"Signal Red",name_zh:"信号红",hex:"#A52019"},{ral:"RAL 3002",name_en:"Carmine Red",name_zh:"胭脂红",hex:"#A2231D"},{ral:"RAL 3003",name_en:"Ruby Red",name_zh:"红宝石红",hex:"#8A1C1C"},{ral:"RAL 3020",name_en:"Traffic Red",name_zh:"交通红",hex:"#CC0605"},{ral:"RAL 5005",name_en:"Signal Blue",name_zh:"信号蓝",hex:"#1E2460"},{ral:"RAL 7035",name_en:"Light Grey",name_zh:"浅灰",hex:"#CBD0CC"},{ral:"RAL 9002",name_en:"Grey White",name_zh:"灰白",hex:"#E7EBDA"}];
    ralPaintMap.find(c=>c.ral==='RAL 7035').baseRecipe={W064:92,BK7H:8};ralPaintMap.find(c=>c.ral==='RAL 5005').baseRecipe={B150S:85,BK7H:15};ralPaintMap.find(c=>c.ral==='RAL 3020').baseRecipe={R254D:90,'073':10};ralPaintMap.find(c=>c.ral==='RAL 9002').baseRecipe={W064:98,BK7H:1.5,Y42S:0.5};ralPaintMap.find(c=>c.ral==='RAL 1007').baseRecipe={Y74S:40,Y83S:40,W064:20};

    document.addEventListener('DOMContentLoaded', () => {
        let paintChart, currentLanguage, currentState = {};
        const elements={ralSearch:document.getElementById("ralSearch"),ralSelect:document.getElementById("ralSelect"),colorSwatch:document.getElementById("colorSwatch"),currentRalCode:document.getElementById("currentRalCode"),currentHex:document.getElementById("currentHex"),volumeSelect:document.getElementById("volumeSelect"),paintSlidersContainer:document.getElementById("paintSlidersContainer"),totalPigmentWeight:document.getElementById("totalPigmentWeight"),scoopEstimate:document.getElementById("scoopEstimate"),varnishAmount:document.getElementById("varnishAmount"),perLiterAmount:document.getElementById("perLiterAmount"),mixingRatio:document.getElementById("mixingRatio"),addFormulaBtn:document.getElementById("addFormulaBtn"),resetFormulaBtn:document.getElementById("resetFormulaBtn"),paintChart:document.getElementById("paintChart"),notification:document.getElementById("notification"),recipePresetsContainer:document.getElementById("recipePresetsContainer"),searchSuggestions:document.getElementById("searchSuggestions"),canLabel:document.getElementById("canLabel"),canBody:document.getElementById("canBody"),exportRecipeBtn:document.getElementById('exportRecipeBtn'),copyRecipeBtn:document.getElementById('copyRecipeBtn'),shareRecipeBtn:document.getElementById('shareRecipeBtn'),generateRecipeBtn:document.getElementById('generateRecipeBtn')};
        const VOLUME_FACTORS={'500ml':0.5,'1l':1,'5l':5,'20l':20};
        const TOTAL_PIGMENT_PER_LITER=106;

        const hexToRgb=hex=>{const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return r?[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16)]:null};const rgbToXyz=(r,g,b)=>{r/=255;g/=255;b/=255;r=r>0.04045?((r+0.055)/1.055)**2.4:r/12.92;g=g>0.04045?((g+0.055)/1.055)**2.4:g/12.92;b=b>0.04045?((b+0.055)/1.055)**2.4:b/12.92;r*=100;g*=100;b*=100;return[r*0.4124+g*0.3576+b*0.1805,r*0.2126+g*0.7152+b*0.0722,r*0.0193+g*0.1192+b*0.9505]};const xyzToLab=(x,y,z)=>{x/=95.047;y/=100;z/=108.883;x=x>0.008856?x**(1/3):7.787*x+16/116;y=y>0.008856?y**(1/3):7.787*y+16/116;z=z>0.008856?z**(1/3):7.787*z+16/116;return[116*y-16,500*(x-y),200*(y-z)]};
        const hexToLab=hex=>xyzToLab(...rgbToXyz(...hexToRgb(hex)));
        Object.values(PAINT_DATA).forEach(p => { if (p.hex) p.lab = hexToLab(p.hex); });

        const showNotification = (message, type = 'success') => { elements.notification.textContent = message; elements.notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform transition-all z-50 text-sm ${type === 'error' ? 'bg-red-600 text-white' : 'bg-dark text-white'} translate-y-0 opacity-100`; setTimeout(() => elements.notification.classList.add('translate-y-24', 'opacity-0'), 3000); };
        const calculateTotals = () => { let total = 0; document.querySelectorAll('#paintSlidersContainer input[type="range"]').forEach(s => total += Number(s.value)); const factor = currentState.volumeFactor; const baseWeight = factor * 1000; elements.totalPigmentWeight.textContent = `${total.toFixed(1)}g`; elements.scoopEstimate.textContent = `(${currentLanguage === 'zh' ? '约' : ''}${Math.round(total / 50)}${currentLanguage === 'zh' ? '勺' : ' spoons'})`; elements.varnishAmount.textContent = `${currentState.volume.toUpperCase()}`; elements.perLiterAmount.textContent = factor > 0 ? `${(total / factor).toFixed(1)}g` : '0.0g'; const ratio = total > 0 ? Math.round((total / (total + baseWeight)) * 100) : 0; elements.mixingRatio.textContent = `${ratio} : ${100 - ratio}`; };
        const updatePaintChart = () => { if (!paintChart) return; const labels = [], data = [], colors = []; Object.keys(PAINT_DATA).forEach(code => { const weight = Number(document.getElementById(`slider${code}`)?.value || 0); if (weight > 0.05) { const paint = PAINT_DATA[code]; labels.push(`${paint[`name_${currentLanguage}`] || paint.name_en} (${weight.toFixed(1)}g)`); data.push(weight); const colorMap = { Y: '#F4C430', '0': '#FF7F00', R: '#B91D23', V: '#800080', B: '#2A58D1', G: '#229954', BK: '#000000', W: '#E0E0E0' }; colors.push(colorMap[code.charAt(0)] || '#CCCCCC'); } }); paintChart.data = { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 1 }] }; paintChart.update(); };
        const resetAllSliders = (notify = false) => { document.querySelectorAll('#paintSlidersContainer input[type="range"]').forEach(s => { s.value = 0; s.dispatchEvent(new Event('input', { bubbles: true })) }); if (notify) showNotification(currentLanguage === 'zh' ? '颜料已清空' : 'Pigments cleared'); };
        
        const updatePaintWeights = (baseRecipe) => { resetAllSliders(); const factor = currentState.volumeFactor; Object.keys(baseRecipe).forEach(code => { const value = (baseRecipe[code] / 100) * TOTAL_PIGMENT_PER_LITER * factor; const slider = document.getElementById(`slider${code}`); if (slider) { slider.value = value; slider.dispatchEvent(new Event('input', { bubbles: true })); } }); };
        const generateReferenceRecipe=()=>{if(!currentState.ral){showNotification("zh"===currentLanguage?"请先选择一个RAL颜色":"Select a RAL color first","error");return}const targetLab=hexToLab(currentState.ral.hex);let recipe={};const pigments=Object.entries(PAINT_DATA);if(targetLab[1]**2+targetLab[2]**2<100){recipe.W064=targetLab[0];recipe.BK7H=100-targetLab[0]}else{const chromatic=pigments.filter(([k])=>k!=='W064'&&k!=='BK7H');chromatic.sort((a,b)=>{const deltaE1=Math.sqrt((targetLab[0]-a[1].lab[0])**2+(targetLab[1]-a[1].lab[1])**2+(targetLab[2]-a[1].lab[2])**2);const deltaE2=Math.sqrt((targetLab[0]-b[1].lab[0])**2+(targetLab[1]-b[1].lab[1])**2+(targetLab[2]-b[1].lab[2])**2);return deltaE1-deltaE2});const[p1,p2,p3]=[chromatic[0],chromatic[1],chromatic[2]];recipe[p1[0]]=0.6;recipe[p2[0]]=0.3;recipe[p3[0]]=0.1;let mixedLab=[0,0,0];Object.entries(recipe).forEach(([k,v])=>{mixedLab[0]+=PAINT_DATA[k].lab[0]*v;mixedLab[1]+=PAINT_DATA[k].lab[1]*v;mixedLab[2]+=PAINT_DATA[k].lab[2]*v;});if(targetLab[0]>mixedLab[0]){recipe.W064=(targetLab[0]-mixedLab[0])/10;}if(targetLab[0]<mixedLab[0]){recipe.BK7H=(mixedLab[0]-targetLab[0])/10;}}let total=0;Object.values(recipe).forEach(v=>total+=v);const finalRecipe={};Object.entries(recipe).forEach(([k,v])=>finalRecipe[k]=v/total*100);currentState.ral.baseRecipe=finalRecipe;updatePaintWeights(finalRecipe);showNotification("zh"===currentLanguage?"参考配方已生成":"Reference recipe generated")};
        const updateColorDisplay = (ralData) => { if (!ralData || !ralData.ral) return; currentState.ral = ralData; const nameKey = `name_${currentLanguage}`; elements.colorSwatch.style.backgroundColor = ralData.hex; elements.currentRalCode.textContent = ` ${ralData.ral} (${ralData[nameKey] || ralData.name_en})`; elements.currentHex.textContent = ` ${ralData.hex.toUpperCase()}`; elements.canLabel.textContent = ralData.ral; elements.canBody.style.backgroundColor = ralData.hex; };
        
        const switchLanguage = (lang) => {
            currentLanguage = lang; document.documentElement.lang = lang === 'zh' ? 'zh-CN' : lang;
            Object.entries(TRANSLATIONS[lang]).forEach(([key, value]) => {
                document.querySelectorAll(`[data-i18n="${key}"]`).forEach(el => {
                    const child = el.children[0];
                    if (key === 'recipe_includes_list') { el.innerHTML = value; }
                    else if (child && (child.nodeName === 'SPAN' || child.nodeName === 'STRONG')) {
                        let textNode = el.firstChild;
                        while(textNode && textNode.nodeType !== 3) { textNode = textNode.nextSibling; }
                        if (textNode) { textNode.nodeValue = value.endsWith(':') ? `${value} ` : value; }
                        else { el.insertBefore(document.createTextNode(value.endsWith(':')? `${value} `: value), child); }
                    } else { el.textContent = value; }
                });
                document.querySelectorAll(`[data-i18n-placeholder="${key}"]`).forEach(el => el.placeholder = value);
            });
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === lang));
            Object.keys(PAINT_DATA).forEach(code => { const el = document.querySelector(`[data-i18n-paint-name="${code}"]`); if (el) el.textContent = `${PAINT_DATA[code][`name_${lang}`] || PAINT_DATA[code].name_en} (${code})`; });
            initRalSelect(); initRecipePresets();
            if (currentState.ral && currentState.ral.ral !== 'RAL') updateColorDisplay(currentState.ral);
        };

        const initUI = () => { const getPaintColor = (code) => {const map={Y:'#F4C430','0':'#FF7F00',R:'#B91D23',V:'#800080',B:'#2A58D1',G:'#229954',BK:'#000000',W:'#FFFFFF'};return map[code.charAt(0)]||'#CCCCCC';}; elements.paintSlidersContainer.innerHTML = Object.entries(PAINT_DATA).map(([code, paint]) => `<div class="space-y-1"><div class="flex items-center justify-between mb-1"><label for="slider${code}" class="text-sm text-gray-700 flex items-center"><span class="paint-dot" style="background-color:${getPaintColor(code)};border-color:${code==='W064'?'#ccc':'transparent'}"></span><span data-i18n-paint-name="${code}"></span></label><div class="flex items-center gap-1"><span id="value${code}" class="weight-display text-gray-800 text-xs font-mono min-w-[40px] text-right pr-1">0.0g</span></div></div><input type="range" id="slider${code}" min="0" max="${TOTAL_PIGMENT_PER_LITER*VOLUME_FACTORS['20l']}" value="0" data-paint="${code}" step="0.1"></div>`).join(''); initPaintChart(); };
        const initRalSelect = () => { const selVal = elements.ralSelect.value; elements.ralSelect.innerHTML = `<option value="">${TRANSLATIONS[currentLanguage].select_ral_code}</option>`; const grouped = ralPaintMap.reduce((acc, c) => { const group = c.ral.split(" ")[1].charAt(0); if (!acc[group]) acc[group] = []; acc[group].push(c); return acc; }, {}); Object.keys(grouped).sort().forEach(group => { const optgroup = document.createElement('optgroup'); optgroup.label = `RAL ${group}000 Series`; grouped[group].sort((a,b) => a.ral.localeCompare(b.ral, undefined, {numeric: true})).forEach(color => { const option = document.createElement('option'); option.value = color.ral; option.textContent = `${color.ral} - ${color[`name_${currentLanguage}`] || color.name_en}`; optgroup.appendChild(option); }); elements.ralSelect.appendChild(optgroup); }); elements.ralSelect.value = selVal; };
        const initRecipePresets = () => { elements.recipePresetsContainer.innerHTML = ralPaintMap.filter(c => c.baseRecipe).map(data => `<button class="recipe-preset bg-white border border-gray-200 rounded-lg p-2 text-center text-xs hover:border-primary hover:bg-primary/5 transition-all duration-200" data-ral="${data.ral}"><div class="w-full h-8 rounded mb-1" style="background-color: ${data.hex};"></div><div class="font-medium">${data[`name_${currentLanguage}`] || data.name_en}</div><div class="text-xs text-gray-500">${data.ral}</div></button>`).join(''); };
        const initPaintChart = () => { if (paintChart) paintChart.destroy(); const ctx = elements.paintChart.getContext('2d'); paintChart = new Chart(ctx, { type: 'doughnut', data: { datasets: [{ borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); };
        
        elements.ralSelect.addEventListener('change', e => { const data = ralPaintMap.find(c => c.ral === e.target.value); if (data) { updateColorDisplay(data); if (data.baseRecipe) { updatePaintWeights(data.baseRecipe); } else { resetAllSliders(); } }});
        elements.volumeSelect.addEventListener('change', () => { currentState.volume = elements.volumeSelect.value; currentState.volumeFactor = VOLUME_FACTORS[currentState.volume]; if (currentState.ral && currentState.ral.baseRecipe) { updatePaintWeights(currentState.ral.baseRecipe); } calculateTotals(); });
        elements.resetFormulaBtn.addEventListener('click', () => resetAllSliders(true));
        elements.addFormulaBtn.addEventListener('click', () => { let hasRecipe = false; document.querySelectorAll('#paintSlidersContainer input[type="range"]').forEach(slider => { const currentValue = Number(slider.value); if (currentValue > 0) { hasRecipe = true; slider.value = currentValue * 1.05; slider.dispatchEvent(new Event('input', { bubbles: true })); } }); if (hasRecipe) { showNotification(currentLanguage === 'zh' ? '配方已微调 (+5%)' : 'Formula adjusted (+5%)'); } else { showNotification(currentLanguage === 'zh' ? '请先加载配方或手动输入颜料' : 'Load or enter a recipe first', 'error'); } });
        elements.generateRecipeBtn.addEventListener('click', generateReferenceRecipe);
        document.querySelectorAll('.lang-btn').forEach(b => b.addEventListener('click', () => switchLanguage(b.dataset.lang)));
        elements.paintSlidersContainer.addEventListener('input', e => { if (e.target.type === 'range') { const code = e.target.dataset.paint; document.getElementById(`value${code}`).textContent = `${Number(e.target.value).toFixed(1)}g`; calculateTotals(); updatePaintChart(); } });
        elements.recipePresetsContainer.addEventListener('click', e => { const btn = e.target.closest('.recipe-preset'); if (!btn) return; const data = ralPaintMap.find(c => c.ral === btn.dataset.ral); if(data) { elements.ralSelect.value = data.ral; updateColorDisplay(data); updatePaintWeights(data.baseRecipe); } });
        elements.ralSearch.addEventListener('input', e => { const term = e.target.value.toLowerCase(); if(!term){elements.searchSuggestions.classList.add('hidden');return;} const results=ralPaintMap.filter(c=>c.ral.toLowerCase().includes(term)||c.name_en.toLowerCase().includes(term)||(c.name_zh&&c.name_zh.includes(term))); elements.searchSuggestions.innerHTML=results.slice(0,5).map(c=>`<div class="p-2 hover:bg-gray-100 cursor-pointer" data-ral="${c.ral}">${c.ral} - ${c[`name_${currentLanguage}`] || c.name_en}</div>`).join(''); elements.searchSuggestions.classList.remove('hidden'); });
        elements.searchSuggestions.addEventListener('click', e => { const el = e.target.closest('[data-ral]'); if(!el) return; const data = ralPaintMap.find(c => c.ral === el.dataset.ral); if(data) { elements.ralSelect.value = data.ral; elements.ralSelect.dispatchEvent(new Event('change')); elements.searchSuggestions.classList.add('hidden'); elements.ralSearch.value='';} });
        document.addEventListener('click', e => { if (!elements.ralSearch.parentElement.contains(e.target)) elements.searchSuggestions.classList.add('hidden');});
        
        currentState = { ral: null, volume: '1l', volumeFactor: 1 };
        initUI();
        switchLanguage(localStorage.getItem('moocow_language') || 'zh');
        updateColorDisplay({ral:'RAL', name_zh:'未选择', name_en:'None', hex:'#FFFFFF'});
        resetAllSliders();
    });
  </script>
</body>
</html>
